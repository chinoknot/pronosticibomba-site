<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PB Analyzer</title>
  <style>
    :root{
      --bg0:#07101e; --bg1:#0a1628; --card:#0b1a2f; --txt:#e9f0ff; --muted:#a9b7d6;
      --line:rgba(255,255,255,.08); --accent:#3aa0ff; --accent2:#22c55e; --warn:#f59e0b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background: radial-gradient(1200px 900px at 85% 20%, rgba(58,160,255,.10) 0%, transparent 55%),
                  radial-gradient(900px 650px at 55% 25%, rgba(34,197,94,.10) 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1200px; margin:26px auto; padding:0 16px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    h1{margin:0; font-size:22px; letter-spacing:.2px;}
    .sub{color:var(--muted); font-size:13px; margin-top:4px;}
    .grid{display:grid; grid-template-columns: 380px 1fr; gap:14px; margin-top:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: rgba(11,26,47,.75);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 8px 26px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:10px; align-items:center;}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input[type="date"], input[type="text"]{
      width:100%; padding:10px 11px; border-radius:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--txt);
      outline:none;
    }
    input[type="text"]::placeholder{color:rgba(169,183,214,.6)}
    button{
      background: rgba(58,160,255,.16);
      color: var(--txt);
      border:1px solid rgba(58,160,255,.35);
      padding:10px 12px; border-radius:12px;
      cursor:pointer;
    }
    button:hover{background: rgba(58,160,255,.22)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .checks{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .chk{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted);}
    .chk input{accent-color: var(--accent);}
    .fixtures{margin-top:12px; max-height:360px; overflow:auto; padding-right:6px;}
    .fx{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 10px; border-radius:14px;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      margin-bottom:8px;
      cursor:pointer;
    }
    .fx:hover{background:rgba(255,255,255,.04)}
    .fx .l{min-width:0}
    .fx .t{font-weight:700; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .fx .m{font-size:12px; color:var(--muted); margin-top:2px;}
    .fx .r{font-family:var(--mono); font-size:12px; color:rgba(240,250,255,.86); white-space:nowrap;}
    .kv{display:grid; grid-template-columns: 160px 1fr; gap:8px; margin-top:10px;}
    .k{color:var(--muted); font-size:12px}
    .v{font-family:var(--mono); font-size:12px}
    .hr{height:1px; background:var(--line); margin:12px 0;}
    .prettyRow{display:grid; grid-template-columns: 1fr 220px; gap:10px; align-items:center; padding:6px 0;}
    .prettyTitle{font-weight:800; margin-bottom:6px;}
    .prettyBody{font-size:13px; line-height:1.35; color: rgba(240,250,255,.92);}
    .muted2{color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      margin-right:8px;
      white-space:nowrap;
    }
    .pill.safe{border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.10)}
    .pill.med{border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.10)}
    .pill.hard{border-color: rgba(244,63,94,.38); background: rgba(244,63,94,.10)}
    pre{
      margin:0; padding:12px; border-radius:14px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color: rgba(240,250,255,.9);
      overflow:auto; max-height:260px;
      font-size:12px;
    }
    .badge{display:inline-flex; align-items:center; gap:8px; font-size:12px; color:var(--muted)}
    .dot{width:8px; height:8px; border-radius:999px; background:var(--warn); box-shadow:0 0 12px rgba(245,158,11,.35);}
  
    /* ---- UX v2: tabs + pro mode + mobile ---- */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      padding-bottom:10px; margin:10px 0 14px;
    }
    .tabs.scroll{flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling:touch; padding-bottom:12px;}
    .tabBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--txt);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .tabBtn.active{
      border-color: rgba(58,160,255,.45);
      background: rgba(58,160,255,.16);
    }
    .tabPanel{display:none}
    .tabPanel.active{display:block}
.proBlock{display:none}
    .topActions{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-top:10px;
    }
    .switch{
      display:flex; align-items:center; gap:8px;
      color:var(--muted); font-size:13px;
      user-select:none;
    }
    .switch input{accent-color: var(--accent);}
    .mini{
      font-size:12px; color:var(--muted);
    }
    .listItem{
      padding:10px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      margin-top:8px;
    }
    .listHead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .listMain{font-weight:800; font-size:14px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .listSub{margin-top:4px; color:var(--muted); font-size:12px; line-height:1.25;}
    .tag{
      display:inline-flex; align-items:center;
      padding:4px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .tag.spicy{border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.10)}
    .tag.high{border-color: rgba(244,63,94,.38); background: rgba(244,63,94,.10)}
    .tag.medium{border-color: rgba(58,160,255,.35); background: rgba(58,160,255,.10)}
    .tag.safe{border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.10)}
    details.fold{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px 10px;
      margin-top:10px;
    }
    details.fold > summary{
      cursor:pointer;
      font-weight:800;
      outline:none;
      list-style:none;
    }
    details.fold > summary::-webkit-details-marker{display:none}
    .stickyBar{
      position: sticky; top: 0;
      background: rgba(7,16,30,.75);
      backdrop-filter: blur(10px);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px 12px;
      z-index: 20;
      margin-bottom: 12px;
    }
    @media (max-width: 980px){
      .wrap{margin:14px auto; padding:0 12px;}
      .card{padding:12px; border-radius:14px;}
      .fixtures{max-height:280px;}
      .tabs{gap:8px;}
      .tabs{display:none;} /* mobile: use accordions instead */
      .tabs.scroll{display:none;}
      .tabPanel{display:block;} /* show all in mobile, but inside accordions */
      .tabPanel.active{display:block;}
      .stickyBar{border-radius:14px;}
      pre{max-height:220px;}
    }


    /* --- Header actions (index-like) --- */
    .langSwitch{display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden; background:rgba(255,255,255,.03)}
    .langBtn{display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; font-size:12px; color:var(--txt); text-decoration:none; border-right:1px solid var(--line)}
    .langBtn:last-child{border-right:none}
    .langBtn.active{background: rgba(58,160,255,.18); border-color: rgba(58,160,255,.45)}
    .donateBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 12px; border-radius:999px; text-decoration:none; font-size:12px; font-weight:800;
      border:1px solid rgba(245,158,11,.45); background: rgba(245,158,11,.12); color: var(--txt);
      white-space:nowrap;
    }
    .donateBtn:hover{background: rgba(245,158,11,.18)}
    /* modern scrollbar */
    .fixtures{scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.25) rgba(255,255,255,.06);}
    .fixtures::-webkit-scrollbar{width:10px}
    .fixtures::-webkit-scrollbar-track{background: rgba(255,255,255,.06); border-radius:999px}
    .fixtures::-webkit-scrollbar-thumb{background: rgba(255,255,255,.22); border-radius:999px; border:2px solid rgba(255,255,255,.06)}

</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1 id="brandTitle">PRONOSTICI BOMBA</h1>
      <div class="sub" id="brandSub">I pronostici non sono copiati: vengono generati giorno per giorno da modelli che analizzano statistiche e dati storici.</div>
    </div>

    <div class="row" style="gap:10px; align-items:center; justify-content:flex-end;">
      <span class="pill" id="dayPill">—</span>

      <div class="langSwitch" role="group" aria-label="Language">
        <a id="langIt" class="langBtn" href="?lang=it">IT</a>
        <a id="langEn" class="langBtn" href="?lang=en">EN</a>
      </div>

      <a class="donateBtn" href="https://www.pronosticibomba.com" target="_blank" rel="noopener">
        REGALA UNO SNACK A RALPH
      </a>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div style="font-weight:800; margin-bottom:10px;" id="fixturesTitle">Partite</div>

      <div class="row">
        <div style="flex:1">
          <label id="lblDate">Data</label>
          <input id="dateInp" type="date" />
        </div>
        <div style="width:120px; align-self:flex-end;">
          <button id="reloadBtn" style="width:100%;">Ricarica</button>
        </div>
      </div>
</div>

      <div class="muted2" style="margin-top:10px;" id="countText">—</div>

      <div id="fixtures" class="fixtures"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div style="font-weight:800; margin-bottom:10px;" id="selTitle">Partita selezionata</div>

      <div class="kv">
        <div class="k" id="lblCompetition">Competizione</div><div class="v" id="selLeague">-</div>
        <div class="k" id="lblKickoff">Kickoff</div><div class="v" id="selKick">-</div>
        <div class="k" id="lblMatch">Match</div><div class="v" id="selMatch">-</div>
        <div class="k" id="lblFixtureId">Fixture ID</div><div class="v" id="selId">-</div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;">
<button id="anBtn" disabled>Analizza (step 1)</button>
      </div>

      
      <div class="hr"></div>

      <!-- Sticky quick bar (nice on mobile too) -->
      <div class="stickyBar">
        <div class="topActions">
          <div class="mini">
            <b id="selMatchMini">-</b><br/>
            <span id="selKickMini">-</span> • <span id="selLeagueMini">-</span> • ID <span id="selIdMini">-</span>
          </div>
</div>
      </div>

      <!-- Desktop tabs -->
      <div class="tabs scroll" id="tabsBar">
        <button class="tabBtn active" data-tab="overview">Overview</button>
        <button class="tabBtn" data-tab="chicche">Chicche</button>
        <button class="tabBtn" data-tab="matchups">Matchups</button>
        <button class="tabBtn" data-tab="players">Players</button>
</div>

      <div class="tabPanel active" id="tab-overview">
        <div class="row" style="gap:14px; align-items:stretch; flex-wrap:wrap;">
          <div class="card" style="flex:1; min-width:320px;">
            <div class="prettyTitle" id="titleGoal">Goal</div>
            <div class="prettyBody" id="goalBox">—</div>
          </div>

          <div class="card" style="flex:1; min-width:320px;">
            <div class="prettyTitle" id="titleOverview">Match in 10 secondi</div>
            <div class="prettyBody" id="exoBox">—</div>
          </div>
        </div>
      </div>

      <div class="tabPanel" id="tab-chicche">
        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle" id="titleChicche">Chicche (alta quota)</div>
          <div class="prettyBody" id="chiccheBox">—</div>
        </div>
      </div>

      <div class="tabPanel" id="tab-matchups">
        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle" id="titleMatchups">Matchups (solo se lineup disponibile)</div>
          <div class="prettyBody" id="matchupsBox">—</div>
        </div>
      </div>

      <div class="tabPanel" id="tab-players">
        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle" id="titlePlayers">Top season-based (contesto)</div>
          <div class="prettyBody" id="playersBox">—</div>
        </div>
      </div>
</div>

      <!-- Mobile: accordions (all visible panels become sections) -->
      <div class="proBlock" style="margin-top:12px;">
        <!-- placeholder, used by pro mode only if you want later -->
      </div>

      <div class="hr"></div>
</div>
  </div>
</div>

<script>
(function(){


  // ---- config ----
  var DEFAULT_BACKEND = "https://pb-analyzer-backend2.vercel.app";
  var backend = DEFAULT_BACKEND;

  // ---- language: ?lang=it|en wins, else browser ----
  function getQueryParam(name){
    try{
      var u = new URL(window.location.href);
      return u.searchParams.get(name);
    }catch(e){ return null; }
  }
  var LANG_PARAM = (getQueryParam("lang") || "").toLowerCase();
  var LANG = (LANG_PARAM === "it" || LANG_PARAM === "en")
    ? LANG_PARAM
    : ((navigator.language || "en").toLowerCase().startsWith("it") ? "it" : "en");
  document.documentElement.lang = LANG;

  var I18N = {
    it: {
      tab_overview: "Panoramica",
      tab_chicche: "Chicche",
      tab_matchups: "Duelli",
      tab_players: "Giocatori",
      fixtures_title: "Partite",
      date_label: "Data",
      reload_btn: "Ricarica",
      matches_shown: "Partite: {n}",
      no_matches: "Nessuna partita trovata.",
      selected_match: "Partita selezionata",
      competition: "Competizione",
      kickoff_local: "Orario (Italia)",
      match_label: "Match",
      fixture_id_label: "Fixture ID",
      chicche_title: "Chicche (alta quota)",
      matchups_title: "Duelli (formazioni)",
      brand_sub: "I pronostici non sono copiati da altri siti: vengono generati giorno per giorno da modelli che analizzano statistiche e dati storici.",
      donate: "REGALA UNO SNACK A RALPH",

      goal_title: "Goal",
      overview_title: "Match in 10 secondi",
      chicche_title: "Chicche (alta quota)",
      matchups_title: "Duelli (solo se formazioni disponibili)",
      players_title: "Top stagionali (contesto)",
      loading: "Caricamento...",
      nd: "—",
      lineups_missing: "Come back 30 minutes before kick-off to see matchups and spicy picks for this game.",
      team_avgs: "Medie squadra (ultime / stagione)",
      match_totals: "Totali match (stima)",
      corners_for_pg: "Corner fatti (pg)",
      corners_against_pg: "Corner subiti (pg)",
      fouls_for_pg: "Falli fatti (pg)",
      fouls_against_pg: "Falli subiti (pg)",
      shots_for_pg: "Tiri fatti (pg)",
      shots_against_pg: "Tiri subiti (pg)",
      sot_for_pg: "Tiri in porta fatti (pg)",
      sot_against_pg: "Tiri in porta subiti (pg)",
      top_shots: "Top Tiri",
      top_sot: "Top Tiri in porta",
      top_fouls: "Top Falli",
      top_cards: "Top Cartellini",
      shots_pg_lbl: "Tiri (pg)",
      sot_pg_lbl: "Tiri in porta (pg)",
      fouls_pg_lbl: "Falli (pg)",
      yellow_pg_lbl: "Gialli (pg)",
      apps: "Pres.",
      pick_sot: "Tiri in porta",
      pick_shots: "Tiri",
      pick_fouls: "Falli",
      pick_card: "Ammonito",
      plus1: "1+",
      plus2: "2+",
      plus3: "3+",
      safe: "Safe",
      risk_medium: "Rischio medio",
      risk_high: "Rischio alto",
      spicy: "Chicca"
    },
    en: {
      tab_overview: "Overview",
      tab_chicche: "Spicy picks",
      tab_matchups: "Matchups",
      tab_players: "Players",
      fixtures_title: "Matches",
      date_label: "Date",
      reload_btn: "Reload",
      matches_shown: "Matches: {n}",
      no_matches: "No matches found.",
      selected_match: "Selected match",
      competition: "Competition",
      kickoff_local: "Kick-off (Italy)",
      match_label: "Match",
      fixture_id_label: "Fixture ID",
      chicche_title: "Spicy picks (higher odds)",
      matchups_title: "Matchups (lineups)",
      brand_sub: "Predictions are not copied from other sites: they are generated day by day by models that analyze stats and historical data.",
      donate: "GIFT A SNACK TO RALPH",

      goal_title: "Goals",
      overview_title: "Match in 10 seconds",
      chicche_title: "Spicy picks (higher odds)",
      matchups_title: "Matchups (only if lineups available)",
      players_title: "Season tops (context)",
      loading: "Loading...",
      nd: "—",
      lineups_missing: "No lineups → matchups n/a",
      team_avgs: "Team averages (recent / season)",
      match_totals: "Match totals (estimate)",
      corners_for_pg: "Corners for (pg)",
      corners_against_pg: "Corners against (pg)",
      fouls_for_pg: "Fouls for (pg)",
      fouls_against_pg: "Fouls against (pg)",
      shots_for_pg: "Shots for (pg)",
      shots_against_pg: "Shots against (pg)",
      sot_for_pg: "SoT for (pg)",
      sot_against_pg: "SoT against (pg)",
      top_shots: "Top Shots",
      top_sot: "Top SoT",
      top_fouls: "Top Fouls",
      top_cards: "Top Cards",
      shots_pg_lbl: "Shots (pg)",
      sot_pg_lbl: "SoT (pg)",
      fouls_pg_lbl: "Fouls (pg)",
      yellow_pg_lbl: "Yellows (pg)",
      apps: "Apps",
      pick_sot: "Shots on target",
      pick_shots: "Shots",
      pick_fouls: "Fouls",
      pick_card: "Booked",
      plus1: "1+",
      plus2: "2+",
      plus3: "3+",
      safe: "Safe",
      risk_medium: "Medium risk",
      risk_high: "High risk",
      spicy: "Spicy"
    }
  };

  function t(k){ return (I18N[LANG] && I18N[LANG][k]) ? I18N[LANG][k] : k; }

  function nf(v, d){
    if (v === null || v === undefined || v === "" || isNaN(v)) return t("nd");
    try{
      var loc = (LANG === "it") ? "it-IT" : "en-GB";
      return new Intl.NumberFormat(loc, { maximumFractionDigits: d, minimumFractionDigits: d })
        .format(Number(v));
    }catch(e){
      return String(v);
    }
  }

  function fmtKickItaly(iso){
    if (!iso) return t("nd");
    try{
      var dt = new Date(iso);
      var loc = (LANG === "it") ? "it-IT" : "en-GB";
      return new Intl.DateTimeFormat(loc, {
        timeZone: "Europe/Rome",
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      }).format(dt);
    }catch(e){
      return iso;
    }
  }

  function localizeStaticUI(){
    var b;
    b = document.querySelector('button[data-tab="overview"]'); if (b) b.textContent = t("tab_overview");
    b = document.querySelector('button[data-tab="chicche"]'); if (b) b.textContent = t("tab_chicche");
    b = document.querySelector('button[data-tab="matchups"]'); if (b) b.textContent = t("tab_matchups");
    b = document.querySelector('button[data-tab="players"]'); if (b) b.textContent = t("tab_players");

    var el;
    el = document.getElementById("titleGoal"); if (el) el.textContent = t("goal_title");
    el = document.getElementById("titleOverview"); if (el) el.textContent = t("overview_title");
    el = document.getElementById("titleChicche"); if (el) el.textContent = t("chicche_title");
    el = document.getElementById("titleMatchups"); if (el) el.textContent = t("matchups_title");
    el = document.getElementById("titlePlayers"); if (el) el.textContent = t("players_title");
  
    var el;
    el = document.getElementById("brandTitle"); if (el) el.textContent = "PRONOSTICI BOMBA";
    el = document.getElementById("brandSub"); if (el) el.textContent = t("brand_sub");
    el = document.querySelector(".donateBtn"); if (el) el.textContent = t("donate");

    el = document.getElementById("fixturesTitle"); if (el) el.textContent = t("fixtures_title");
    el = document.getElementById("lblDate"); if (el) el.textContent = t("date_label");
    el = document.getElementById("reloadBtn"); if (el) el.textContent = t("reload_btn");

    el = document.getElementById("selTitle"); if (el) el.textContent = t("selected_match");
    el = document.getElementById("lblCompetition"); if (el) el.textContent = t("competition");
    el = document.getElementById("lblKickoff"); if (el) el.textContent = t("kickoff_local");
    el = document.getElementById("lblMatch"); if (el) el.textContent = t("match_label");
    el = document.getElementById("lblFixtureId"); if (el) el.textContent = t("fixture_id_label");

    el = document.getElementById("titleChicche"); if (el) el.textContent = t("chicche_title");
    el = document.getElementById("titleMatchups"); if (el) el.textContent = t("matchups_title");

    updateDayPill();
    setupLangUI();
}

  // ---- state ----
  var allFixtures = [];
  var filteredFixtures = [];
  var selected = null;

  // ---- dom ----
  var dateInp = document.getElementById("dateInp");
  var qInp = null;
var reloadBtn = document.getElementById("reloadBtn");
  var fixturesEl = document.getElementById("fixtures");
  var countText = document.getElementById("countText");
var anBtn = document.getElementById("anBtn");
  var rawOut = document.getElementById("rawOut");
  var backendLbl = null;
var backendFoot = null;
var selLeague = document.getElementById("selLeague");
  var selKick = document.getElementById("selKick");
  var selMatch = document.getElementById("selMatch");
  var selId = document.getElementById("selId");

  var goalBox = document.getElementById("goalBox");
  var exoBox = document.getElementById("exoBox");
  var playersBox = document.getElementById("playersBox");
  var matchupsBox = document.getElementById("matchupsBox");
  var chiccheBox = document.getElementById("chiccheBox");
  var betsBox = document.getElementById("betsBox"); // (beta) may be null

  // ---- UX v2 ----
  var selLeagueMini = document.getElementById("selLeagueMini");
  var selKickMini = document.getElementById("selKickMini");
  var selMatchMini = document.getElementById("selMatchMini");
  var selIdMini = document.getElementById("selIdMini");
  var proToggle = null;
  var tabsBar = document.getElementById("tabsBar");

  function setMiniFromSelected(fx){
    if (!fx){
      selLeagueMini.textContent = "-";
      selKickMini.textContent = "-";
      selMatchMini.textContent = "-";
      selIdMini.textContent = "-";
      return;
    }
    selLeagueMini.textContent = fx.league_name || fx.league || "-";
    selKickMini.textContent = fx.kickoff_utc ? fmtKickItaly(fx.kickoff_utc) : "-";
    selMatchMini.textContent = (fx.home_name || "") + " vs " + (fx.away_name || "");
    selIdMini.textContent = String(fx.fixture_id || "-");
  }

  function setTab(name){
    if (!tabsBar) return;
    var btns = tabsBar.querySelectorAll(".tabBtn");
    for (var i=0;i<btns.length;i++){
      btns[i].classList.toggle("active", btns[i].getAttribute("data-tab") === name);
    }
    var panels = document.querySelectorAll(".tabPanel");
    for (var j=0;j<panels.length;j++){
      panels[j].classList.toggle("active", panels[j].id === ("tab-"+name));
    }
  }

  if (tabsBar){
    tabsBar.addEventListener("click", function(e){
      var t = e.target;
      if (t && t.classList && t.classList.contains("tabBtn")){
        var name = t.getAttribute("data-tab");
        if (name) setTab(name);
      }
    });
  }
  function setBackend(b){ backend = b || DEFAULT_BACKEND; }


  function pad2(n){ n = String(n||""); return n.length<2 ? ("0"+n) : n; }

  function todayISO(){
    var d = new Date();
    var y = d.getUTCFullYear();
    var m = pad2(d.getUTCMonth()+1);
    var da = pad2(d.getUTCDate());
    return y + "-" + m + "-" + da;
  }

  function fmtNum(x, d){
    if (d === undefined) d = 2;
    if (x === null || x === undefined) return "—";
    var n = Number(x);
    if (!isFinite(n)) return "—";
    return n.toFixed(d);
  }

  function pct(x, d){
    if (d === undefined) d = 1;
    if (x === null || x === undefined) return "—";
    var n = Number(x);
    if (!isFinite(n)) return "—";
    return (n*100).toFixed(d) + "%";
  }

  function safeGet(obj, pathArr){
    var cur = obj;
    for (var i=0;i<pathArr.length;i++){
      if (!cur) return undefined;
      cur = cur[pathArr[i]];
    }
    return cur;
  }

  function getCheckedLeagueIds(){
    return [];
  }
    return out;
  }

  function pill(text, cls){
    var c = cls ? ("pill "+cls) : "pill";
    return '<span class="'+c+'">'+escapeHtml(text)+'</span>';
  }

  function escapeHtml(s){
    return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function renderFixtures(){
    fixturesEl.innerHTML = "";
    if (countText) countText.innerHTML = t("matches_shown").replace("{n}", String(filteredFixtures.length || 0));

    if (!filteredFixtures.length){
      fixturesEl.innerHTML = '<div class="muted2">'+escapeHtml(t("no_matches"))+'</div>';
      return;
    }

    for (var i=0;i<filteredFixtures.length;i++){
      (function(fx){
        var div = document.createElement("div");
        div.className = "fx";
        var left = document.createElement("div");
        left.className = "l";
        var t = document.createElement("div");
        t.className = "t";
        t.textContent = (fx.home_name + " vs " + fx.away_name);
        var m = document.createElement("div");
        m.className = "m";
        m.textContent = fx.league_name ? fx.league_name : "—";
        left.appendChild(t); left.appendChild(m);

        var right = document.createElement("div");
        right.className = "r";
        right.textContent = fx.kickoff_utc ? fmtKickItaly(fx.kickoff_utc) : t("nd");

        div.appendChild(left); div.appendChild(right);

        div.addEventListener("click", function(){
          selectFixture(fx);
        });

        fixturesEl.appendChild(div);
      })(filteredFixtures[i]);
    }
  }

  function applyFilters(){
    filteredFixtures = allFixtures.slice();
  }

  function selectFixture(fx){
    selected = fx;
    selLeague.textContent = fx.league_name || fx.league || "-";
    selKick.textContent = fx.kickoff_utc ? fmtKickItaly(fx.kickoff_utc) : "-";
    selMatch.textContent = fx.home_name + " vs " + fx.away_name;
    selId.textContent = String(fx.fixture_id || "-");
    anBtn.disabled = !fx.fixture_id;
    if (rawOut) rawOut.textContent = "Pronto. Premi Analizza.";
    goalBox.textContent = t("nd");
    exoBox.textContent = t("nd");
    playersBox.textContent = t("nd");
    matchupsBox.textContent = t("nd");
    var noLineups = exotics && exotics.meta && exotics.meta.lineups && exotics.meta.lineups.available === false;
      chiccheBox.textContent = noLineups ? t("lineups_missing") : t("nd");
    betsBox && (betsBox.textContent = "—");
    setMiniFromSelected(fx);
    setTab("overview");
  }

  function normalizeFixturesResponse(resp){
    // backend /api/fixtures dovrebbe tornare array di fixture.
    // Gestiamo alcuni formati possibili.
    if (!resp) return [];
    if (Array.isArray(resp)) return resp;
    if (Array.isArray(resp.response)) return resp.response;
    if (Array.isArray(resp.fixtures)) return resp.fixtures;
    return [];
  }

  function loadFixtures(){
    var date = dateInp.value || todayISO();
    dateInp.value = date;

    var leagueIds = getCheckedLeagueIds();
    var url = backend.replace(/\/$/,"") + "/api/fixtures?date=" + encodeURIComponent(date);
    if (leagueIds.length){
      url += "&league_ids=" + encodeURIComponent(leagueIds.join(","));
    }
    url += "&cb=" + Date.now();

    reloadBtn.disabled = true;
    fixturesEl.innerHTML = '<div class="muted2">'+t("loading")+'</div>';

    fetch(url, { method:"GET" })
      .then(function(r){
        return r.json();
      })
      .then(function(data){
        var fx = normalizeFixturesResponse(data);
        // normalizza campi minimi attesi in UI
        allFixtures = fx.map(function(x){
          var homeName =
            safeGet(x, ["home","name"]) ||
            safeGet(x, ["home_name"]) ||
            safeGet(x, ["homeName"]) ||
            safeGet(x, ["teams","home","name"]) ||
            safeGet(x, ["teams","homeName"]) ||
            safeGet(x, ["homeTeam","name"]) ||
            safeGet(x, ["home"]) ||
            safeGet(x, ["team_home","name"]) ||
            "";

          var awayName =
            safeGet(x, ["away","name"]) ||
            safeGet(x, ["away_name"]) ||
            safeGet(x, ["awayName"]) ||
            safeGet(x, ["teams","away","name"]) ||
            safeGet(x, ["teams","awayName"]) ||
            safeGet(x, ["awayTeam","name"]) ||
            safeGet(x, ["away"]) ||
            safeGet(x, ["team_away","name"]) ||
            "";

          if (!homeName || !awayName) {
            var ms = String(
              safeGet(x, ["match"]) ||
              safeGet(x, ["title"]) ||
              safeGet(x, ["name"]) ||
              safeGet(x, ["fixture_title"]) ||
              ""
            );
            if (ms.indexOf(" vs ") > -1) {
              var p = ms.split(" vs ");
              if (!homeName) homeName = p[0] || homeName;
              if (!awayName) awayName = p[1] || awayName;
            } else if (ms.indexOf(" v ") > -1) {
              var p2 = ms.split(" v ");
              if (!homeName) homeName = p2[0] || homeName;
              if (!awayName) awayName = p2[1] || awayName;
            } else if (ms.indexOf(" - ") > -1) {
              var p3 = ms.split(" - ");
              if (!homeName) homeName = p3[0] || homeName;
              if (!awayName) awayName = p3[1] || awayName;
            }
          }

          return {
            fixture_id: safeGet(x, ["fixture_id"]) || safeGet(x, ["fixture","id"]) || safeGet(x, ["fixture","fixture_id"]) || safeGet(x, ["id"]),
            kickoff_utc: safeGet(x, ["kickoff_utc"]) || safeGet(x, ["fixture","date"]) || safeGet(x, ["kickoff"]) || safeGet(x, ["date"]),
            league_id: safeGet(x, ["league_id"]) || safeGet(x, ["league","id"]) || null,
            league_name: safeGet(x, ["league_name"]) || safeGet(x, ["league","name"]) || safeGet(x, ["league"]) || "",
            league: safeGet(x, ["league"]) || safeGet(x, ["league","name"]) || "",
            season: safeGet(x, ["season"]) || safeGet(x, ["league","season"]) || null,
            home_id: safeGet(x, ["home","id"]) || safeGet(x, ["teams","home","id"]) || safeGet(x, ["home_id"]) || null,
            away_id: safeGet(x, ["away","id"]) || safeGet(x, ["teams","away","id"]) || safeGet(x, ["away_id"]) || null,
            home_name: String(homeName || "").trim(),
            away_name: String(awayName || "").trim()
          };
        });
applyFilters();
        reloadBtn.disabled = false;
      })
      .catch(function(err){
        reloadBtn.disabled = false;
        fixturesEl.innerHTML = '<div class="muted2">Errore fixtures. Apri console.</div>';
        console.error("fixtures error:", err);
      });
  }

  // --- Poisson helpers ---
  function poissonP(k, lambda){
    // P(X=k) = e^-λ * λ^k / k!
    if (!(lambda>=0)) return null;
    if (!(k>=0)) return null;
    var p = Math.exp(-lambda);
    for (var i=1; i<=k; i++){
      p = p * (lambda / i);
    }
    return p;
  }

  function poissonCdf(k, lambda){
    var s = 0;
    for (var i=0;i<=k;i++){
      var p = poissonP(i, lambda);
      if (p === null) return null;
      s += p;
    }
    return s;
  }

  function pOver(threshold, lambda){
    // P(X > threshold)
    // threshold è tipo 1.5 -> quindi P(X >= 2)
    var k = Math.floor(threshold + 1e-9);
    var cdf = poissonCdf(k, lambda);
    if (cdf === null) return null;
    return 1 - cdf;
  }

  function renderGoals(model){
    if (!model) { goalBox.textContent = t("nd"); return; }
    var lt = model.lambda_total;
    var lh = model.lambda_home;
    var la = model.lambda_away;
    if (!(lt>=0)) { goalBox.textContent = t("nd"); return; }

    var html = "";
    html += '<div>λ totale: <b>'+fmtNum(lt,2)+'</b> (home '+fmtNum(lh,2)+' / away '+fmtNum(la,2)+')</div>';
    html += '<div style="margin-top:8px;">P Over 1.5 <b style="float:right">'+pct(pOver(1.5, lt),1)+'</b></div>';
    html += '<div style="margin-top:6px;">P Over 2.5 <b style="float:right">'+pct(pOver(2.5, lt),1)+'</b></div>';
    html += '<div style="margin-top:6px;">P Over 3.5 <b style="float:right">'+pct(pOver(3.5, lt),1)+'</b></div>';
    goalBox.innerHTML = html;
  }

  function renderExotics(exotics, fixture){
    if (!exotics){
      exoBox.textContent = t("nd");
      return;
    }

    try{
      var out = '';
      var teams = exotics.teams || {};
      var home = teams.home || {};
      var away = teams.away || {};

      out += '<div class="muted2"><b>'+escapeHtml(t("team_avgs"))+'</b></div>';

      function kv(name, val){
        if (val === null || val === undefined) return '';
        return '<div class="kv"><div class="muted2">'+escapeHtml(name)+'</div><div><b>'+nf(val,2)+'</b></div></div>';
      }

      function teamBlock(label, tblock){
        if (!tblock || !tblock.season_avgs) return '';
        var a = tblock.season_avgs;
        var h = '';
        h += '<div style="font-weight:800; margin-top:10px;">'+escapeHtml(label)+'</div>';
        h += '<div class="grid2">';
        h += kv(t("corners_for_pg"), a.corners_for_pg);
        h += kv(t("corners_against_pg"), a.corners_against_pg);
        h += kv(t("fouls_for_pg"), a.fouls_for_pg);
        h += kv(t("fouls_against_pg"), a.fouls_against_pg);
        h += kv(t("shots_for_pg"), a.shots_for_pg);
        h += kv(t("shots_against_pg"), a.shots_against_pg);
        h += kv(t("sot_for_pg"), a.sot_for_pg);
        h += kv(t("sot_against_pg"), a.sot_against_pg);
        h += '</div>';
        return h;
      }

      out += teamBlock(home.name || "Home", home);
      out += teamBlock(away.name || "Away", away);

      var totals = exotics.totals || {};
      if (totals && (totals.shots_total || totals.sot_total || totals.corners_total || totals.fouls_total || totals.cards_total)){
        out += '<div class="hr"></div>';
        out += '<div class="muted2"><b>'+escapeHtml(t("match_totals"))+'</b></div>';
        var g = '<div class="grid2">';
        if (totals.shots_total) g += kv('Shots', totals.shots_total.mean);
        if (totals.sot_total) g += kv('SoT', totals.sot_total.mean);
        if (totals.corners_total) g += kv('Corners', totals.corners_total.mean);
        if (totals.fouls_total) g += kv('Fouls', totals.fouls_total.mean);
        if (totals.cards_total) g += kv('Cards', totals.cards_total.mean);
        g += '</div>';
        out += g;
      }

      exoBox.innerHTML = out || t("nd");
    }catch(e){
      exoBox.textContent = t("nd");
    }
  }


  function renderPlayers(exotics){
    var players = exotics && exotics.players;
    if (!players){
      playersBox.textContent = t("nd");
      return;
    }

    function metricLine(label, key, it){
      var v = it && it[key];
      return '• '+escapeHtml(it.name)+' ('+escapeHtml(it.position||'')+') — '+escapeHtml(label)+': <b>'+nf(v,2)+'</b> — '+escapeHtml(t("apps"))+': '+escapeHtml(it.apps);
    }

    function section(teamName, block){
      if (!block) return '';
      var out = '<div style="font-weight:800; margin-bottom:6px;">'+escapeHtml(teamName)+'</div>';

      function one(title, arr, label, key){
        if (!arr || !arr.length) return '';
        var s = '<div class="muted2" style="margin-top:8px;"><b>'+escapeHtml(title)+'</b></div>';
        for (var i=0;i<arr.length;i++){
          s += '<div>'+metricLine(label, key, arr[i])+'</div>';
        }
        return s;
      }

      out += one(t("top_shots"), block.topShots, t("shots_pg_lbl"), "shots_per_game");
      out += one(t("top_sot"), block.topSoT, t("sot_pg_lbl"), "sot_per_game");
      out += one(t("top_fouls"), block.topFouls, t("fouls_pg_lbl"), "fouls_per_game");
      out += one(t("top_cards"), block.topCards, t("yellow_pg_lbl"), "yellow_per_game");
      return out;
    }

    var out = '';
    out += section((exotics && exotics.teams && exotics.teams.home && exotics.teams.home.name) ? exotics.teams.home.name : 'Home', players.home);
    out += '<div class="hr"></div>';
    out += section((exotics && exotics.teams && exotics.teams.away && exotics.teams.away.name) ? exotics.teams.away.name : 'Away', players.away);

    playersBox.innerHTML = out || t("nd");
  }



  function renderMatchups(exotics, fixture){
    var m = exotics && exotics.matchups;
    if (!m || !m.available || !m.top5){
      matchupsBox.textContent = t("lineups_missing");
      return;
    }

    function sec(title, arr, statKey, label){
      if (!arr || !arr.length) return '';
      var out = '<div class="muted2" style="margin-top:10px;"><b>'+escapeHtml(title)+'</b></div>';
      for (var i=0;i<arr.length;i++){
        var it = arr[i] || {};
        var stat = it[statKey];
        out += '<div class="listItem">';
        out +=   '<div class="listHead"><div class="listMain"><b>'+escapeHtml(it.name||t("nd"))+'</b></div></div>';
        if (stat !== null && stat !== undefined){
          out += '<div class="listSub" style="margin-top:8px;">• '+escapeHtml(label)+': '+nf(stat,2)+'</div>';
        }
        out += '</div>';
      }
      return out;
    }

    var top = m.top5;
    var h = '';
    h += sec(t("top_shots"), (top.reliable && top.reliable.shots) || [], "shots_per90", "Shots p90");
    h += sec(t("top_sot"), (top.reliable && top.reliable.sot) || [], "sot_per90", "SoT p90");
    h += sec(t("top_fouls"), (top.reliable && top.reliable.fouls) || [], "fouls_per90", "Fouls p90");
    h += sec(t("top_cards"), (top.reliable && top.reliable.cards) || [], "yellow_per90", "Y p90");

    matchupsBox.innerHTML = h || t("nd");
  }




    
  function renderChicche(exotics){
    var c = exotics && exotics.chicche;
    if (!c || !c.available || !c.picks || !c.picks.length){
      chiccheBox.textContent = t("nd");
      return;
    }

    function plusFromLine(line){
      if (line === 0.5) return t("plus1");
      if (line === 1.5) return t("plus2");
      if (line === 2.5) return t("plus3");
      return "";
    }

    function pickLabel(p){
      var m = String(p.market||"").toLowerCase();
      var l = Number(p.line);
      if (m.indexOf("shots on target")>-1 || m.indexOf("sot")>-1) return t("pick_sot")+" "+plusFromLine(l);
      if (m.indexOf("player shots")>-1 || m === "player shots") return t("pick_shots")+" "+plusFromLine(l);
      if (m.indexOf("foul")>-1) return t("pick_fouls")+" "+plusFromLine(l);
      if (m.indexOf("yellow")>-1 || m.indexOf("card")>-1) return t("pick_card");
      return (p.market || "Pick");
    }

    function p90Line(p){
      var why = (p && p.why) ? p.why : [];
      for (var i=0;i<why.length;i++){
        var s = String(why[i]||"");
        if (s.indexOf("p90")>-1 || s.indexOf("p/90")>-1) return s;
      }
      return "";
    }

    function riskTag(tier){
      var t0 = String(tier||"").toLowerCase();
      var cls = (t0 === "spicy") ? "spicy" : (t0 === "high" ? "high" : (t0 === "medium" ? "medium" : "safe"));
      var label = (t0 === "spicy") ? t("spicy") : (t0 === "high" ? t("risk_high") : (t0 === "medium" ? t("risk_medium") : t("safe")));
      return '<span class="tag '+cls+'">'+escapeHtml(label)+'</span>';
    }

    var out = '';
    for (var j=0;j<c.picks.length;j++){
      var p = c.picks[j] || {};
      out += '<div class="listItem">';
      out +=   '<div class="listHead">';
      out +=     '<div class="listMain"><b>'+escapeHtml(p.name||t("nd"))+'</b> <span class="muted2">'+escapeHtml(pickLabel(p))+'</span></div>';
      out +=     (p.risk_tier ? riskTag(p.risk_tier) : '');
      out +=   '</div>';
      var st = p90Line(p);
      if (st) out += '<div class="listSub" style="margin-top:8px;">• '+escapeHtml(st)+'</div>';
      out += '</div>';
    }

    chiccheBox.innerHTML = out || t("nd");
  }


function renderBets(exotics){
    if (!betsBox) return;
    var bets = exotics && exotics.bets;
    if (!bets){ betsBox.textContent = "—"; return; }

    function fmtNum(x, d){
      if (x === null || x === undefined) return "—";
      if (typeof x !== "number" || !isFinite(x)) return "—";
      return x.toFixed(d == null ? 2 : d);
    }

    function renderOne(kind, obj){
      if (!obj) return '';
      var cls = (kind === "easy") ? "safe" : (kind === "medium" ? "med" : "hard");
      var title = escapeHtml(obj.name || kind.toUpperCase());
      var tgt   = escapeHtml(obj.target || obj.target_odds || "—");
      var q     = fmtNum(obj.est_total_odds, 2);

      var out = '';
      out += '<div class="betCard">';
      out +=   '<div class="betHead">';
      out +=     pill(title, cls);
      var q_real = fmtNum(obj.total_odds_real, 2);
      var hasReal = (q_real !== "—");
      var q_show = hasReal ? q_real : q;
      var label = hasReal ? "quota reale" : "quota stimata";
      out +=     '<span class="betMeta">'+label+' <b>'+q_show+'</b> <span class="muted2">('+tgt+')</span></span>';
      out +=   '</div>';

      var legs = obj.legs || [];
      for (var i=0;i<legs.length;i++){
        var leg = legs[i] || {};
        var mkt = leg.market || leg.label || ("Leg "+(i+1));
        var team = leg.team ? (' — ' + escapeHtml(leg.team)) : '';
        var selection = escapeHtml(leg.selection || "—");
        var oddsVal = (leg.odds_real != null && typeof leg.odds_real === "number" && isFinite(leg.odds_real)) ? leg.odds_real
                  : ((leg.est_odds != null && typeof leg.est_odds === "number" && isFinite(leg.est_odds)) ? leg.est_odds : null);
        var odds = (oddsVal != null) ? ('<span class="muted2">@'+oddsVal.toFixed(2)+(leg.odds_real != null ? ' (real)' : '')+'</span>') : '';
        var pos = leg.position ? (' <span class="muted2">['+escapeHtml(leg.position)+']</span>') : '';
        var line = (leg.line != null && typeof leg.line === "number" && isFinite(leg.line)) ? ('<span class="muted2">('+leg.line.toFixed(1)+')</span>') : '';

        out += '<div class="prettyRow">';
        out +=   '<div class="prTop">'+escapeHtml(mkt)+team+' '+line+'</div>';
        out +=   '<div class="prBot">'+selection+' '+odds+pos+'</div>';
        out += '</div>';
      }

      if (obj.note){
        out += '<div class="muted2" style="margin-top:6px;">'+escapeHtml(obj.note)+'</div>';
      }
      out += '</div>';
      return out;
    }

    var html = '';
    html += renderOne("easy", bets.easy);
    html += renderOne("medium", bets.medium);
    html += renderOne("hard", bets.hard);
    betsBox.innerHTML = html || "—";
  }

  function runAnalyze(){
    if (!selected || !selected.fixture_id) return;

    anBtn.disabled = true;
    if (rawOut) rawOut.textContent = "Analisi in corso...";
    goalBox.textContent = t("nd");
    exoBox.textContent = t("nd");
    playersBox.textContent = t("nd");
    matchupsBox.textContent = t("nd");
    chiccheBox.textContent = t("nd");
    if (betsBox) betsBox.textContent = "—";

    var url = backend.replace(/\/$/,"") + "/api/analyze?cb=" + Date.now();

    fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ fixture_id: selected.fixture_id })
    })
    .then(function(r){
      return r.json().then(function(j){ return { ok:r.ok, status:r.status, body:j }; });
    })
    .then(function(res){
      if (!res.ok){
        if (rawOut) rawOut.textContent = JSON.stringify(res.body, null, 2);
        throw new Error("analyze "+res.status+" "+JSON.stringify(res.body));
      }
      var d = res.body;
      window.lastAnalysis = d;

      if (rawOut) rawOut.textContent = JSON.stringify(d, null, 2);

      renderGoals(d.goals_model);
      renderExotics(d.exotics, d.fixture);
      renderPlayers(d.exotics, d.fixture);
      renderMatchups(d.exotics, d.fixture);
      renderChicche(d.exotics);
      if (typeof renderBets === 'function') renderBets(d.exotics);

      // UX: dopo analisi, apri subito Chicche
      setTab('chicche');
      anBtn.disabled = false;
    })
    .catch(function(err){
      console.error(err);
      if (rawOut) rawOut.textContent = "Errore analisi. Apri console.";
      anBtn.disabled = false;
    });
  }

  // ---- events ----
  reloadBtn.addEventListener("click", function(){ loadFixtures(); });
});
  var leagueBoxes = document.querySelectorAll("input.lg");
  for (var i=0;i<leagueBoxes.length;i++){
    leagueBoxes[i].addEventListener("change", function(){ loadFixtures(); });
  }
  dateInp.addEventListener("change", function(){ loadFixtures(); });
  anBtn.addEventListener("click", function(){ runAnalyze(); });

  // ---- init ----
  setBackend(DEFAULT_BACKEND);
  try{ localizeStaticUI(); }catch(e){}
  if (typeof setMiniFromSelected === 'function') setMiniFromSelected(null);
  dateInp.value = todayISO();
  setTab('overview');
  loadFixtures();
  function setupLangUI(){
    var it = document.getElementById("langIt");
    var en = document.getElementById("langEn");
    if (!it || !en) return;

    it.classList.toggle("active", LANG === "it");
    en.classList.toggle("active", LANG === "en");

    function buildHref(lang){
      try{
        var u = new URL(window.location.href);
        u.searchParams.set("lang", lang);
        return u.pathname + "?" + u.searchParams.toString() + u.hash;
      }catch(e){
        return "?lang=" + lang;
      }
    }
    it.setAttribute("href", buildHref("it"));
    en.setAttribute("href", buildHref("en"));
  }

  function updateDayPill(){
    var pill = document.getElementById("dayPill");
    if (!pill) return;
    var d = (dateInp && dateInp.value) ? dateInp.value : todayISO();
    try{
      var dt = new Date(d + "T12:00:00");
      var opt = { weekday:"long", year:"numeric", month:"long", day:"2-digit", timeZone:"Europe/Rome" };
      var loc = (LANG === "en") ? "en-GB" : "it-IT";
      pill.textContent = dt.toLocaleDateString(loc, opt).toUpperCase();
    }catch(e){
      pill.textContent = d;
    }
  }

})();
</script>
</body>
</html>
