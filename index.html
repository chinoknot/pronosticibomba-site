<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Pronostici Bomba</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e2a3b, #050816);
      color: #f5f5f5;
    }
    main {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 24px 40px;
    }
    h1 {
      font-size: 2.4rem;
      margin-bottom: 4px;
    }
    p.subtitle {
      margin-top: 0;
      margin-bottom: 24px;
      color: #c7d0df;
      font-size: 0.95rem;
    }
    #reload-btn {
      border: 1px solid #3b82f6;
      background: #111827;
      color: #e5e7eb;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    #reload-btn:hover {
      background: #1f2937;
    }
    #picks-container {
      margin-top: 12px;
      font-size: 0.95rem;
    }
    .cat-title {
      margin-top: 24px;
      margin-bottom: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      border-left: 3px solid #3b82f6;
      padding-left: 8px;
    }
    .cat-block {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .pick-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    .pick-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .teams {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .pick-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    .pick-label {
      font-size: 0.9rem;
    }
    .odd {
      font-weight: 600;
      color: #facc15;
    }
    .meta {
      font-size: 0.7rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <main>
    <h1>Pronostici Bomba</h1>
    <p class="subtitle">
      Picks generati automaticamente dal modello (solo calcio maschile, top campionati).
    </p>

    <button id="reload-btn" onclick="loadTodayPicks()">
      Picks per <span id="picks-title"></span>
    </button>

    <div id="picks-container">Carico i picks di oggi...</div>
  </main>

  <script>
    const SHEETDB_URL = "https://sheetdb.io/api/v1/ou6vl5uzwgsda";

    function formatDateIT(dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      return d.toLocaleDateString("it-IT", {
        weekday: "long",
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });
    }

    function parseMatchDateTime(row) {
      if (!row.match_date || !row.match_time) return null;
      return new Date(row.match_date + "T" + row.match_time + ":00");
    }

    async function loadTodayPicks() {
      const container = document.getElementById("picks-container");
      const titleSpan = document.getElementById("picks-title");

      if (!container || !titleSpan) {
        console.error("Manca picks-container o picks-title nell’HTML");
        return;
      }

      container.innerHTML = "Carico i picks di oggi...";

      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10); // es. "2025-11-30"
      titleSpan.textContent = formatDateIT(todayStr);

      try {
        // usa run_date corretto
        const url = `${SHEETDB_URL}/search?sheet=PICKS&run_date=${todayStr}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        // solo partite di oggi
        let picks = rows.filter(r => r.match_date === todayStr);

        // NON filtriamo più per orario: vogliamo vedere anche quelle già giocate

        // ordina per orario
        picks.sort((a, b) => {
          const da = parseMatchDateTime(a);
          const db = parseMatchDateTime(b);
          if (!da || !db) return 0;
          return da - db;
        });

        if (!picks.length) {
          container.innerHTML = "Nessun pick generato per oggi (ancora).";
          return;
        }

        // raggruppa per categoria
        const byCategory = {};
        for (const p of picks) {
          const cat = p.category || "ALTRO";
          if (!byCategory[cat]) byCategory[cat] = [];
          byCategory[cat].push(p);
        }

        let html = "";
        for (const [cat, list] of Object.entries(byCategory)) {
          html += `<h2 class="cat-title">${cat}</h2>`;
          html += `<div class="cat-block">`;
          for (const p of list) {
            const dt = parseMatchDateTime(p);
            const timeStr = dt
              ? dt.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" })
              : (p.match_time || "-");

            const oddNum = Number(p.odd || 0);

            html += `
              <div class="pick-card">
                <div class="pick-header">
                  <span class="league">${p.league} (${p.country})</span>
                  <span class="time">${timeStr}</span>
                </div>
                <div class="teams">${p.home} – ${p.away}</div>
                <div class="pick-main">
                  <span class="pick-label">${p.pick}</span>
                  <span class="odd">@ ${oddNum ? oddNum.toFixed(2) : "-"}</span>
                </div>
                <div class="meta">
                  <span class="model">${p.model}</span>
                  <span class="score">score: ${Number(p.score || 0).toFixed(3)}</span>
                </div>
              </div>
            `;
          }
          html += `</div>`;
        }

        container.innerHTML = html;

      } catch (err) {
        console.error("Errore nel caricamento dei picks:", err);
        container.innerHTML = "Errore nel caricamento dei picks.";
      }
    }

    document.addEventListener("DOMContentLoaded", loadTodayPicks);
  </script>
</body>
</html>
