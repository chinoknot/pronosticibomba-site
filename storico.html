<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Storico ROI – Pronostici Bomba</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0f172a;
      --card: #020617;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.18);
      --border: rgba(148, 163, 184, 0.2);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --accent-strong: #fb923c;
      --shadow-soft: 0 20px 45px rgba(15, 23, 42, 0.95);
      --danger: #f97373;
      --success: #4ade80;
      --pending: #eab308;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(249, 115, 22, 0.18), transparent 60%),
                  #020617;
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    body {
      min-height: 100vh;
      padding: 20px 10px 32px;
      display: flex;
      justify-content: center;
    }

    main {
      width: 100%;
      max-width: 1100px;
    }

    header {
      margin-bottom: 14px;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 4px;
    }

    h1 {
      font-size: 1.35rem;
      font-weight: 650;
      letter-spacing: 0.03em;
    }

    .back-link {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
    }

    .back-link:hover {
      border-color: rgba(248, 250, 252, 0.6);
      color: #e5e7eb;
    }

    .subtitle {
      font-size: 0.86rem;
      color: var(--text-soft);
      max-width: 700px;
      line-height: 1.5;
    }

    .controls-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .range-fixed-pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.78rem;
      color: var(--text-main);
    }

      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .range-label {
      font-weight: 500;
    }

    #range-select {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    .summary-card {
      margin-top: 14px;
      margin-bottom: 14px;
      padding: 12px 12px;
      border-radius: 18px;
      background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.28), transparent 65%),
                  linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      border: 1px solid rgba(37, 99, 235, 0.5);
      box-shadow: var(--shadow-soft);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 8px;
      font-size: 0.82rem;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .summary-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .summary-value {
      font-size: 1rem;
      font-weight: 600;
    }

    .summary-value-small {
      font-size: 0.86rem;
      font-weight: 500;
    }

    .badge-pos {
      color: #bbf7d0;
    }

    .badge-neg {
      color: #fecaca;
    }

    .badge-neutral {
      color: var(--text-main);
    }

    /* ==== STORICO COMBO_TICKETS (NON PIÙ USATO IN UI) ==== */

    .combo-historical {
      margin-top: 22px;
    }

    .combo-hint {
      font-size: 0.86rem;
      opacity: 0.86;
      margin-bottom: 10px;
    }

    .combo-summary-wrapper {
      margin-top: 6px;
    }

    .combo-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 10px;
    }

    .combo-summary-card {
      border-radius: 14px;
      padding: 10px 12px;
      background: radial-gradient(circle at top right, rgba(148,163,184,0.18), transparent 60%),
                  linear-gradient(135deg, #020617, #020617);
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 12px 30px rgba(15,23,42,0.95);
      font-size: 0.84rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .combo-summary-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .combo-summary-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .combo-summary-meta span {
      opacity: 0.9;
    }

    .combo-summary-badge {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .combo-summary-empty {
      font-size: 0.85rem;
      opacity: 0.8;
      padding: 4px 2px;
    }

    /* TABLES */
    .section-title {
      margin-top: 24px;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .table-wrapper {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(30, 64, 175, 0.4);
      box-shadow: var(--shadow-soft);
      padding: 12px 10px 10px;
      margin-bottom: 18px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      min-width: 600px;
    }

    thead {
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(30, 64, 175, 0.3);
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }

    tbody tr:hover {
      background: rgba(30, 64, 175, 0.35);
    }

    td {
      font-size: 0.8rem;
    }

    .empty {
      font-size: 0.85rem;
      color: var(--text-muted);
      padding: 6px 4px;
    }

    .info-block {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 0.82rem;
      color: var(--text-soft);
    }

    .info-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .info-list {
      list-style: disc;
      padding-left: 16px;
      margin-top: 4px;
    }

    .info-list li {
      margin-bottom: 4px;
    }

    .info-list strong {
      color: #e5e7eb;
    }

    .badge-win {
      color: var(--success);
    }

    .badge-lose {
      color: var(--danger);
    }

    .badge-pending {
      color: var(--pending);
    }

    .badge-unknown {
      color: var(--text-muted);
    }

    @media (max-width: 720px) {
      body {
        padding: 12px 6px 24px;
      }

      .summary-card {
        border-radius: 14px;
      }

      .table-wrapper {
        border-radius: 14px;
      }

      table {
        font-size: 0.78rem;
      }

      th, td {
        padding: 6px;
      }
    }

    @media (max-width: 560px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead {
        display: none;
      }

      table {
        min-width: 0;
      }

      tr {
        margin-bottom: 10px;
        border-radius: 10px;
        border: 1px solid rgba(30, 64, 175, 0.5);
        overflow: hidden;
      }

      td {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 4px 4px;
        font-size: 0.8rem;
      }

      td::before {
        content: attr(data-label);
        font-weight: 500;
        color: var(--text-muted);
        margin-right: 8px;
        text-transform: none;
        letter-spacing: 0;
        font-size: 0.78rem;
      }
    }

    .roi-toggle {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      margin-left: 6px;
    }
    .roi-toggle button {
      appearance: none;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      cursor: pointer;
      transition: transform 0.05s ease, border-color 0.15s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .roi-toggle button:hover {
      border-color: rgba(248, 250, 252, 0.6);
      transform: translateY(-1px);
    }
    .roi-toggle button.active {
      border-color: rgba(249, 115, 22, 0.9);
      background: var(--accent-soft);
      color: #fff;
    }

  </style>
</head>
<body>
  <main>
    <header>
      <div class="title-row">
        <h1>Storico ROI</h1>
        <a href="/index.html" class="back-link">← Torna ai pronostici di oggi</a>
      </div>
      <p class="subtitle">
        Qui trovi il rendimento storico con stake fisso 1 unità.
        Puoi scegliere se calcolare il ROI <strong>per pronostico</strong> (ogni pick = 1 stake)
        oppure <strong>per evento</strong> (1 stake per partita/fixture, scegliendo la pick risolta migliore).
        Il ROI e il profitto sono calcolati solo sulle righe con esito WIN/LOSE; le quote
        sono quelle mostrate al momento della generazione.
      </p>

      <div class="controls-row">
        <span class="range-label">Intervallo analizzato</span>
        <span class="range-fixed-pill">Ultimi 30 giorni (fisso)</span>

        <div class="roi-toggle" aria-label="Modalità calcolo ROI">
          <button id="roi-mode-event" type="button">Per evento</button>
          <button id="roi-mode-pick" type="button">Per pronostico</button>
        </div>
      </div>

    </header>

    <section class="summary-card">
      <div class="summary-item">
        <span class="summary-label">ROI totale</span>
        <span id="summary-roi" class="summary-value badge-neutral">-</span>
        <span id="summary-profit" class="summary-value-small badge-neutral">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Periodo coperto</span>
        <span id="summary-period" class="summary-value-small">-</span>
        <span id="summary-days" class="summary-value-small" style="color: var(--text-muted);">-</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Winrate & affidabilità</span>
        <span id="summary-winrate" class="summary-value badge-neutral">-</span>
        <span id="summary-wl" class="summary-value-small" style="color: var(--text-muted);">-</span>
        <span id="summary-winrate-needed" class="summary-value-small" style="color: var(--text-muted);">-</span>
        <span id="summary-reliability" class="summary-value-small badge-neutral">-</span>
      </div>
    </section>

    <h2 class="section-title">Andamento giornaliero (solo picks risolte)</h2>
    <div id="table-container"></div>

    <!--
    ===== STORICO SCHEDINE PRONTE (COMBO) – RIMOSSO DALLA UI =====
    <section class="combo-historical">
      <h2 class="section-title">
        Storico schedine pronte (combo) – ROI dedicato
      </h2>
      <p class="combo-hint">
        Queste sono le schedine generate automaticamente dai modelli (raddoppio,
        quota 5/6, 10/12 e over 20). Il loro rendimento <strong>non è incluso</strong>
        nel ROI globale: qui vedi solo lo storico di queste multipla, con stake fisso
        1 unità per schedina chiusa.
      </p>
      <div id="combo-summary" class="combo-summary-wrapper"></div>
    </section>
    -->

    <section class="info-block">
      <div class="info-title">Come leggere ROI, winrate e reliability</div>
      <ul class="info-list">
        <li><strong>ROI</strong>: profitto percentuale rispetto allo stake totale. Es:
          ROI 12% significa 12 unità di profitto ogni 100 giocate.</li>
        <li><strong>Winrate</strong>: percentuale di pronostici vinti sul totale
          (solo picks con esito WIN/LOSE).</li>

        <li><strong>Modalità calcolo</strong>:
          <ul class="info-list">
            <li><strong>Per pronostico</strong>: ogni pick conta come una giocata (stake 1 ciascuna).</li>
            <li><strong>Per evento</strong>: ogni partita (fixture_id) conta una sola volta (stake 1), scegliendo la pick risolta con score più alto.</li>
          </ul>
        </li>

        <li><strong>Quota media & winrate necessaria</strong>:
          ogni quota media ha un winrate di pareggio (break-even). Esempio:
          quota media 1.80 ⇒ winrate necessaria ≈ 55.6%.</li>
        <li><strong>Reliability</strong>:
          un indicatore qualitativo che prende in considerazione:
          <ul class="info-list">
            <li>numero di pronostici giocati (più è alto, meglio è);</li>
            <li>quanto il winrate effettivo è sopra (o sotto) il winrate di pareggio;</li>
            <li>stabilità del ROI nel periodo selezionato.</li>
          </ul>
        </li>
        <li><strong>Campione ridotto</strong>:
          se le picks sono poche, la reliability viene penalizzata.
          Se i dati sono pochi, viene mostrato <em>Dati pochi (campione ridotto)</em>.</li>
      </ul>
    </section>
  </main>

<script>
  // ===== CONFIG SUPABASE (solo lettura) =====
  const SUPABASE_URL = "https://oiudaxsyvhjpjjhglejd.supabase.co";
  const SUPABASE_ANON_KEY =
     "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pdWRheHN5dmhqcGpqaGdsZWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDk0OTcsImV4cCI6MjA3OTU4NTQ5N30.r7kz3FdijAhsJLz1DcEtobJLaPCqygrQGgCPpSc-05A";


  // ===== ROI MODE =====
  // "event" = 1 stake per fixture (sceglie la pick risolta migliore per partita)
  // "pick"  = 1 stake per pick (comportamento attuale)
  let ROI_MODE = (localStorage.getItem("roi_mode") || "event").toLowerCase();

  function applyRoiToggleUI() {
    const bEvent = document.getElementById("roi-mode-event");
    const bPick = document.getElementById("roi-mode-pick");
    if (!bEvent || !bPick) return;
    bEvent.classList.toggle("active", ROI_MODE === "event");
    bPick.classList.toggle("active", ROI_MODE === "pick");
  }

  function setRoiMode(mode) {
    const m = (mode || "").toLowerCase();
    ROI_MODE = (m === "pick") ? "pick" : "event";
    localStorage.setItem("roi_mode", ROI_MODE);
    applyRoiToggleUI();
    // ricarico storico
    loadHistory(DAYS_FIXED);
  }



  async function sbFetch(table, query) {
    const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
    const res = await fetch(url, {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      },
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Supabase error ${res.status}: ${text}`);
    }
    return await res.json();
  }

  // ===== HELPER =====
  function pad2(n) {
    return n < 10 ? "0" + n : "" + n;
  }

  function formatDateIT(str) {
    if (!str) return "";
    const parts = str.split("-");
    if (parts.length !== 3) return str;
    const [y, m, d] = parts;
    return `${d}/${m}/${y}`;
  }

  function getLastNDates(n) {
    const dates = [];
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    for (let i = 0; i < n; i++) {
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      const y = d.getFullYear();
      const m = pad2(d.getMonth() + 1);
      const day = pad2(d.getDate());
      dates.push(`${y}-${m}-${day}`);
    }
    return dates;
  }

  function safeOdd(o) {
    const n = Number(o);
    if (!isFinite(n) || n <= 1) return 1.0;
    return n;
  }

  // ===== NOMI ELEGANTI CATEGORIE =====
  const CATEGORY_LABELS = {
    BEST_TIPS_OF_DAY: "Scelte d’Élite",
    SAFE_PICKS: "Selezioni Affidabili",
    VALUE_PICKS: "Quote di Valore",
    OVER_UNDER_TIPS: "Tendenze Goal",
    BTTS_TIPS: "Probabilità Entrambe",
    DAILY_2PLUS: "Combo Selettiva",
    DAILY_10PLUS: "Combo High Stakes",
    SINGLE_GAME: "Pick Esclusiva",
    TOP_5_TIPS: "Top 5 Esclusive",
  };

  function getCategoryLabel(cat) {
    const k = (cat || "").trim().toUpperCase();
    return CATEGORY_LABELS[k] || (cat || "Altro").replace(/_/g, " ");
  }

  // (ticket type labels e loadComboHistory restano definiti
  // ma non vengono più usati nella UI)

  const TICKET_TYPE_LABELS = {
    X2: "Raddoppio di giornata",
    X5: "Quota 5/6",
    X10: "Quota 10/12",
    X20: "Quota over 20",
  };

  function getTicketTypeLabel(type, fallback) {
    const k = (type || "").trim().toUpperCase();
    return TICKET_TYPE_LABELS[k] || fallback || k || "Combo";
  }

  // ===== FASCE CONFIDENZA (stessa logica della home) =====
  const CONFIDENCE_ORDER = [
    "Molto alta",
    "Alta",
    "Medio-alta",
    "Media",
    "Bassa",
    "Rischiosa"
  ];

  function confidenceLabelFromScore(score) {
    const val = Number(score || 0) * 100;
    if (val > 130) return "Molto alta";
    if (val > 110) return "Alta";
    if (val > 90)  return "Medio-alta";
    if (val > 70)  return "Media";
    if (val > 50)  return "Bassa";
    return "Rischiosa";
  }

  // ranking dei risultati: preferiamo righe con esito definito e match finito
  function resultRank(r) {
    let score = 0;
    const res = (r.result || "").toUpperCase();
    const st = (r.status_short || "").toUpperCase();

    if (res === "WIN" || res === "LOSE") score += 4;
    else if (res === "PENDING") score += 1;

    if (["FT", "AET", "PEN"].includes(st)) score += 4;
    else if (["2H", "HT"].includes(st)) score += 2;

    if (res === "WIN") score += 2;
    if (res === "LOSE") score += 1;

    return score;
  }

  function reliabilityLabel(totalPicks, winrate, neededWinrate) {
    if (!totalPicks || !isFinite(winrate) || !isFinite(neededWinrate)) {
      return "Dati insufficienti";
    }
    const diff = winrate - neededWinrate;

    if (totalPicks < 20) {
      if (diff >= 5) return "Buona ma campione ridotto";
      if (diff >= 0) return "Ok ma campione ridotto";
      return "Dati pochi (campione ridotto)";
    }

    if (totalPicks < 50) {
      if (diff >= 5) return "Buona";
      if (diff >= 0) return "Discreta";
      if (diff >= -3) return "Debole";
      return "Negativa";
    }

    if (diff >= 7) return "Molto buona";
    if (diff >= 3) return "Buona";
    if (diff >= 0) return "Discreta";
    if (diff >= -3) return "Debole";
    return "Negativa";
  }

  async function fetchDayStats(dateStr) {
    const picks = await sbFetch(
      "picks",
      `?match_date=eq.${dateStr}&select=*`
    );

    if (!Array.isArray(picks) || picks.length === 0) {
      return {
        date: dateStr,
        wins: 0,
        loses: 0,
        stake: 0,
        profit: 0,
        avgOdd: null,
        confidenceStats: {},
        categoryStats: {},
      };
    }

    const results = await sbFetch(
      "results",
      `?picks_date=eq.${dateStr}&select=*`
    );

    const resultMap = new Map();
    if (Array.isArray(results)) {
      for (const r of results) {
        const fid = String(r.fixture_id || "").trim();
        const pickText = String(r.pick || "").trim();
        if (!fid && !pickText) continue;
        const key = fid + "__" + pickText;

        const existing = resultMap.get(key);
        if (!existing || resultRank(r) > resultRank(existing)) {
          resultMap.set(key, r);
        }
      }
    }

    function pickResult(p) {
      const fid = String(p.fixture_id || "").trim();
      const pickText = String(p.pick || "").trim();
      const key = fid + "__" + pickText;
      const res = resultMap.get(key) || {};
      return (res.result || "").toUpperCase();
    }

    function chooseBestResolvedPick(list) {
      const resolved = list.filter(p => {
        const r = pickResult(p);
        return r === "WIN" || r === "LOSE";
      });
      if (!resolved.length) return null;

      resolved.sort((a, b) => {
        const sa = Number(a.score || 0);
        const sb = Number(b.score || 0);
        if (sb !== sa) return sb - sa;

        // tie-break: odd più alta
        const oa = safeOdd(a.odd);
        const ob = safeOdd(b.odd);
        return ob - oa;
      });

      return resolved[0];
    }

    let wins = 0;
    let loses = 0;
    let stake = 0;
    let profit = 0;
    let oddsSum = 0;
    let oddsCount = 0;

    const confBands = {};
    const categories = {};

    function ensureBand(label) {
      if (!confBands[label]) {
        confBands[label] = { wins: 0, loses: 0, stake: 0, profit: 0, oddsSum: 0, oddsCount: 0 };
      }
      return confBands[label];
    }

    function ensureCategory(key) {
      const catKey = (key || "ALTRO").trim() || "ALTRO";
      if (!categories[catKey]) {
        categories[catKey] = { wins: 0, loses: 0, stake: 0, profit: 0, oddsSum: 0, oddsCount: 0 };
      }
      return categories[catKey];
    }

    function applyResolved(p, result) {
      const odd = safeOdd(p.odd);
      const confLabel = confidenceLabelFromScore(p.score || 0);
      const band = ensureBand(confLabel);
      const c = ensureCategory(p.category);

      stake += 1;
      band.stake += 1;
      c.stake += 1;

      if (result === "WIN") {
        wins += 1;
        profit += odd - 1;
        band.wins += 1;
        band.profit += odd - 1;
        c.wins += 1;
        c.profit += odd - 1;
      } else {
        loses += 1;
        profit -= 1;
        band.loses += 1;
        band.profit -= 1;
        c.loses += 1;
        c.profit -= 1;
      }

      oddsSum += odd;
      oddsCount += 1;
      band.oddsSum += odd;
      band.oddsCount += 1;
      c.oddsSum += odd;
      c.oddsCount += 1;
    }

    if (ROI_MODE === "pick") {
      // === modalità attuale: 1 stake per pick ===
      for (const p of picks) {
        const fid = String(p.fixture_id || "").trim();
        const pickText = String(p.pick || "").trim();
        if (!fid && !pickText) continue;

        const result = pickResult(p);
        if (result === "WIN" || result === "LOSE") {
          applyResolved(p, result);
        }
      }
    } else {
      // === modalità realistica: 1 stake per evento (fixture_id) ===
      const byFixture = {};
      for (const p of picks) {
        const fid = String(p.fixture_id || "").trim();
        if (!fid) continue;
        if (!byFixture[fid]) byFixture[fid] = [];
        byFixture[fid].push(p);
      }

      for (const fid of Object.keys(byFixture)) {
        const chosen = chooseBestResolvedPick(byFixture[fid]);
        if (!chosen) continue;
        const result = pickResult(chosen);
        if (result === "WIN" || result === "LOSE") {
          applyResolved(chosen, result);
        }
      }
    }

    const avgOdd = oddsCount > 0 ? oddsSum / oddsCount : null;

    return {
      date: dateStr,
      wins,
      loses,
      stake,
      profit,
      avgOdd,
      confidenceStats: confBands,
      categoryStats: categories,
    };
  }
async function loadHistory(daysBack) {
    const tableContainer = document.getElementById("table-container");
    tableContainer.innerHTML = `
      <div class="table-wrapper">
        <div class="empty">Carico dati degli ultimi ${daysBack} giorni...</div>
      </div>
    `;

    const dates = getLastNDates(daysBack);

    try {
      const statsListRaw = await Promise.all(
        dates.map(d => fetchDayStats(d).catch(() => null))
      );

      const statsList = statsListRaw.filter(s => s && s.stake > 0);

      if (!statsList || statsList.length === 0) {
        tableContainer.innerHTML = `
          <div class="table-wrapper">
            <div class="empty">
              Nessun dato disponibile nel periodo selezionato.
            </div>
          </div>
        `;
        document.getElementById("summary-period").textContent = "-";
        document.getElementById("summary-days").textContent = "-";
        document.getElementById("summary-winrate").textContent = "-";
        document.getElementById("summary-wl").textContent = "-";
        document.getElementById("summary-roi").textContent = "-";
        document.getElementById("summary-profit").textContent = "-";
        document.getElementById("summary-winrate-needed").textContent = "-";
        document.getElementById("summary-reliability").textContent = "-";
        return;
      }

      const byDay = new Map();
      const byCategory = {};
      const byConfidence = {};

      let totalWins = 0;
      let totalLoses = 0;
      let totalStake = 0;
      let totalProfit = 0;
      let totalOddsSum = 0;
      let totalOddsCount = 0;

      for (const s of statsList) {
        byDay.set(s.date, {
          wins: s.wins,
          loses: s.loses,
          stake: s.stake,
          profit: s.profit,
        });

        totalWins += s.wins;
        totalLoses += s.loses;
        totalStake += s.stake;
        totalProfit += s.profit;
        if (s.avgOdd) {
          totalOddsSum += s.avgOdd * (s.wins + s.loses);
          totalOddsCount += (s.wins + s.loses);
        }

        for (const [bandKey, b] of Object.entries(s.confidenceStats || {})) {
          if (!byConfidence[bandKey]) {
            byConfidence[bandKey] = {
              wins: 0,
              loses: 0,
              stake: 0,
              profit: 0,
              oddsSum: 0,
              oddsCount: 0,
            };
          }
          const dest = byConfidence[bandKey];
          dest.wins += b.wins || 0;
          dest.loses += b.loses || 0;
          dest.stake += b.stake || 0;
          dest.profit += b.profit || 0;
          dest.oddsSum += b.oddsSum || 0;
          dest.oddsCount += b.oddsCount || 0;
        }

        for (const [catKey, c] of Object.entries(s.categoryStats || {})) {
          if (!byCategory[catKey]) {
            byCategory[catKey] = {
              wins: 0,
              loses: 0,
              stake: 0,
              profit: 0,
              oddsSum: 0,
              oddsCount: 0,
            };
          }
          const dest = byCategory[catKey];
          dest.wins += c.wins || 0;
          dest.loses += c.loses || 0;
          dest.stake += c.stake || 0;
          dest.profit += c.profit || 0;
          dest.oddsSum += c.oddsSum || 0;
          dest.oddsCount += c.oddsCount || 0;
        }
      }

      const startDate = statsList[statsList.length - 1].date;
      const endDate = statsList[0].date;
      const periodLabel = `${formatDateIT(startDate)} → ${formatDateIT(endDate)}`;
      const daysEffective = statsList.length;

      document.getElementById("summary-period").textContent = periodLabel;
      document.getElementById("summary-days").textContent =
        `${daysEffective} giorni con picks giocate`;

      const totalPlayed = totalWins + totalLoses;
      const winrateTotal =
        totalPlayed > 0 ? ((totalWins / totalPlayed) * 100).toFixed(1) : "-";
      const roiTotal =
        totalStake > 0 ? ((totalProfit / totalStake) * 100).toFixed(1) : "-";
      const avgOddGlobal =
        totalOddsCount > 0 ? (totalOddsSum / totalOddsCount) : null;
      const winrateNeededGlobal =
        avgOddGlobal && avgOddGlobal > 1
          ? (100 / avgOddGlobal).toFixed(1)
          : "-";

      const roiEl = document.getElementById("summary-roi");
      const profitEl = document.getElementById("summary-profit");
      if (roiTotal === "-") {
        roiEl.textContent = "-";
        roiEl.className = "summary-value badge-neutral";
        profitEl.textContent = "-";
        profitEl.className = "summary-value-small badge-neutral";
      } else {
        roiEl.textContent = `${roiTotal}%`;
        const roiNum = parseFloat(roiTotal);
        roiEl.className =
          "summary-value " + (roiNum >= 0 ? "badge-pos" : "badge-neg");

        const profLabel =
          totalProfit >= 0
            ? `Profitto totale: +${totalProfit.toFixed(2)} unità`
            : `Profitto totale: ${totalProfit.toFixed(2)} unità`;
        profitEl.textContent = profLabel;
        profitEl.className =
          "summary-value-small " + (totalProfit >= 0 ? "badge-pos" : "badge-neg");
      }

      const wrEl = document.getElementById("summary-winrate");
      const wlEl = document.getElementById("summary-wl");
      if (winrateTotal === "-") {
        wrEl.textContent = "-";
        wrEl.className = "summary-value badge-neutral";
        wlEl.textContent = "-";
      } else {
        wrEl.textContent = `${winrateTotal}%`;
        wrEl.className = "summary-value badge-neutral";
        wlEl.textContent = `${totalWins} win / ${totalLoses} lose (solo picks con esito definito)`;
      }

      const winNeedEl = document.getElementById("summary-winrate-needed");
      if (winrateNeededGlobal === "-") {
        winNeedEl.textContent = "Winrate necessaria: -";
      } else {
        winNeedEl.textContent =
          `Winrate necessaria per break-even: ${winrateNeededGlobal}% (quota media ~ ${avgOddGlobal.toFixed(2)})`;
      }

      const relEl = document.getElementById("summary-reliability");
      if (winrateTotal === "-" || winrateNeededGlobal === "-") {
        relEl.textContent = "-";
        relEl.className = "summary-value-small badge-neutral";
      } else {
        const wrNum = parseFloat(winrateTotal);
        const needNum = parseFloat(winrateNeededGlobal);
        const label = reliabilityLabel(totalPlayed, wrNum, needNum);
        relEl.textContent = `Reliability: ${label}`;
        let cls = "badge-neutral";
        if (label.startsWith("Molto") || label.startsWith("Buona")) cls = "badge-pos";
        else if (label.startsWith("Debole") || label.startsWith("Negativa")) cls = "badge-neg";
        relEl.className = "summary-value-small " + cls;
      }

      const sortedDays = Array.from(byDay.keys()).sort().reverse();

      let html = `
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Picks giocate</th>
                <th>Win</th>
                <th>Lose</th>
                <th>ROI giornaliero</th>
                <th>Profitto</th>
              </tr>
            </thead>
            <tbody>
      `;

      for (const day of sortedDays) {
        const s = byDay.get(day);
        const played = s.wins + s.loses;
        const roiDay =
          s.stake > 0 ? ((s.profit / s.stake) * 100).toFixed(1) : "-";
        const profitStr =
          s.profit >= 0 ? `+${s.profit.toFixed(2)}` : s.profit.toFixed(2);
        const roiClass =
          roiDay === "-"
            ? "badge-neutral"
            : parseFloat(roiDay) >= 0
            ? "badge-pos"
            : "badge-neg";

        html += `
          <tr>
            <td data-label="Data">${formatDateIT(day)}</td>
            <td data-label="Picks giocate">${played}</td>
            <td data-label="Win">${s.wins}</td>
            <td data-label="Lose">${s.loses}</td>
            <td data-label="ROI giornaliero" class="${roiClass}">
              ${roiDay === "-" ? "-" : roiDay + "%"}
            </td>
            <td data-label="Profitto">${profitStr} u</td>
          </tr>
        `;
      }

      html += `
            </tbody>
          </table>
        </div>
      `;

      const catKeys = Object.keys(byCategory);
      if (catKeys.length) {
        html += `
          <div class="table-wrapper">
            <h2 class="section-title">Rendimento per categoria di modello</h2>
            <table>
              <thead>
                <tr>
                  <th>Categoria</th>
                  <th>Picks giocate</th>
                  <th>Win</th>
                  <th>Lose</th>
                  <th>Winrate</th>
                  <th>ROI (stake=1)</th>
                  <th>Quota media</th>
                  <th>Winrate pareggio</th>
                  <th>Reliability</th>
                </tr>
              </thead>
              <tbody>
        `;

        for (const catKey of catKeys) {
          const c = byCategory[catKey];
          const playedCat = c.wins + c.loses;
          const winrateCat =
            playedCat > 0 ? ((c.wins / playedCat) * 100).toFixed(1) : "-";
          const roiCat =
            c.stake > 0
              ? ((c.profit / c.stake) * 100).toFixed(1)
              : "-";
          const avgOdd =
            c.oddsCount > 0
              ? (c.oddsSum / c.oddsCount)
              : null;
          const avgOddStr = avgOdd ? avgOdd.toFixed(2) : "-";
          const winNeedCat =
            avgOdd && avgOdd > 1
              ? (100 / avgOdd).toFixed(1)
              : "-";

          const roiCatClass =
            roiCat === "-"
              ? "badge-neutral"
              : parseFloat(roiCat) >= 0
              ? "badge-pos"
              : "badge-neg";

          let relLabel = "-";
          let relClass = "badge-neutral";
          if (winrateCat !== "-" && winNeedCat !== "-") {
            const wrNum = parseFloat(winrateCat);
            const needNum = parseFloat(winNeedCat);
            relLabel = reliabilityLabel(playedCat, wrNum, needNum);
            if (relLabel.startsWith("Molto") || relLabel.startsWith("Buona")) {
              relClass = "badge-pos";
            } else if (relLabel.startsWith("Debole") || relLabel.startsWith("Negativa")) {
              relClass = "badge-neg";
            }
          }

          html += `
            <tr>
              <td data-label="Categoria">${getCategoryLabel(catKey)}</td>
              <td data-label="Picks giocate">${playedCat}</td>
              <td data-label="Win">${c.wins}</td>
              <td data-label="Lose">${c.loses}</td>
              <td data-label="Winrate">${winrateCat === "-" ? "-" : winrateCat + "%"}</td>
              <td data-label="ROI" class="${roiCatClass}">${roiCat === "-" ? "-" : roiCat + "%"}</td>
              <td data-label="Quota media">${avgOddStr}</td>
              <td data-label="Winrate pareggio">${winNeedCat === "-" ? "-" : winNeedCat + "%"}</td>
              <td data-label="Reliability" class="${relClass}">${relLabel}</td>
            </tr>
          `;
        }

        html += `
              </tbody>
            </table>
          </div>
        `;
      }

      const bandKeys = Object.keys(byConfidence);
      if (bandKeys.length) {
        const byConfOrdered = {};
        for (const label of CONFIDENCE_ORDER) {
          if (byConfidence[label]) byConfOrdered[label] = byConfidence[label];
        }
        for (const k of bandKeys) {
          if (!byConfOrdered[k]) byConfOrdered[k] = byConfidence[k];
        }

        html += `
          <div class="table-wrapper">
            <h2 class="section-title" style="margin-top:4px;">
              Rendimento per fascia di confidenza modello
            </h2>
            <table>
              <thead>
                <tr>
                  <th>Fascia confidenza</th>
                  <th>Picks giocate</th>
                  <th>Win</th>
                  <th>Lose</th>
                  <th>Winrate</th>
                  <th>ROI (stake=1)</th>
                  <th>Quota media</th>
                  <th>Winrate pareggio</th>
                  <th>Reliability</th>
                </tr>
              </thead>
              <tbody>
        `;

        for (const bandKey of Object.keys(byConfOrdered)) {
          const c = byConfOrdered[bandKey];
          const playedBand = c.wins + c.loses;
          const winrateBand =
            playedBand > 0 ? ((c.wins / playedBand) * 100).toFixed(1) : "-";
          const roiBand =
            c.stake > 0
              ? ((c.profit / c.stake) * 100).toFixed(1)
              : "-";
          const avgOddBand =
            c.oddsCount > 0
              ? (c.oddsSum / c.oddsCount)
              : null;
          const avgOddBandStr = avgOddBand ? avgOddBand.toFixed(2) : "-";
          const winNeedBand =
            avgOddBand && avgOddBand > 1
              ? (100 / avgOddBand).toFixed(1)
              : "-";

          const roiBandClass =
            roiBand === "-"
              ? "badge-neutral"
              : parseFloat(roiBand) >= 0
              ? "badge-pos"
              : "badge-neg";

          let relLabelB = "-";
          let relClassB = "badge-neutral";
          if (winrateBand !== "-" && winNeedBand !== "-") {
            const wrNumB = parseFloat(winrateBand);
            const needNumB = parseFloat(winNeedBand);
            relLabelB = reliabilityLabel(playedBand, wrNumB, needNumB);
            if (relLabelB.startsWith("Molto") || relLabelB.startsWith("Buona")) {
              relClassB = "badge-pos";
            } else if (relLabelB.startsWith("Debole") || relLabelB.startsWith("Negativa")) {
              relClassB = "badge-neg";
            }
          }

          html += `
            <tr>
              <td data-label="Confidenza modello">${bandKey}</td>
              <td data-label="Picks giocati">${playedBand}</td>
              <td data-label="Win">${c.wins}</td>
              <td data-label="Lose">${c.loses}</td>
              <td data-label="Winrate">${winrateBand === "-" ? "-" : winrateBand + "%"}</td>
              <td data-label="ROI" class="${roiBandClass}">${roiBand === "-" ? "-" : roiBand + "%"}</td>
              <td data-label="Quota media">${avgOddBandStr}</td>
              <td data-label="Winrate pareggio">${winNeedBand === "-" ? "-" : winNeedBand + "%"}</td>
              <td data-label="Reliability" class="${relClassB}">${relLabelB}</td>
            </tr>
          `;
        }

        html += `
              </tbody>
            </table>
          </div>
        `;
      }

      tableContainer.innerHTML = html;
    } catch (err) {
      console.error(err);
      tableContainer.innerHTML = `
        <div class="table-wrapper">
          <div class="empty">
            Errore nel caricamento dei dati. Riprova tra qualche minuto.
          </div>
        </div>
      `;
    }
  }

  // ===== STORICO SCHEDINE COMBO (NON CHIAMATO) =====
  async function loadComboHistory(daysBack) {
    const container = document.getElementById("combo-summary");
    if (!container) return;

    container.innerHTML = `
      <div class="combo-summary-empty">
        Carico storico delle schedine...
      </div>
    `;

    const dates = getLastNDates(daysBack);
    if (!dates.length) {
      container.innerHTML = `
        <div class="combo-summary-empty">
          Nessuna data disponibile.
        </div>
      `;
      return;
    }

    const today = dates[0];
    const fromDate = dates[dates.length - 1];

    try {
      const tickets = await sbFetch(
        "combo_tickets",
        `?run_date=gte.${fromDate}&run_date=lte.${today}&select=*`
      );

      if (!Array.isArray(tickets) || !tickets.length) {
        container.innerHTML = `
          <div class="combo-summary-empty">
            Nessuna schedina generata in questo intervallo.
          </div>
        `;
        return;
      }

      const results = await sbFetch(
        "results",
        `?picks_date=gte.${fromDate}&picks_date=lte.${today}&select=*`
      );

      const resultMap = new Map();
      if (Array.isArray(results)) {
        for (const r of results) {
          const fid = String(r.fixture_id || "").trim();
          const pickText = String(r.pick || "").trim();
          if (!fid && !pickText) continue;
          const key = fid + "__" + pickText;

          const current = resultMap.get(key);
          if (!current || resultRank(r) >= resultRank(current)) {
            resultMap.set(key, r);
          }
        }
      }

      const statsByType = {};
      let globalStake = 0;
      let globalProfit = 0;
      let globalWins = 0;
      let globalLoses = 0;

      function ensureType(type, label) {
        if (!statsByType[type]) {
          statsByType[type] = {
            label,
            played: 0,
            wins: 0,
            loses: 0,
            stake: 0,
            profit: 0,
          };
        }
        return statsByType[type];
      }

      for (const t of tickets) {
        const type = (t.ticket_type || "").toUpperCase();
        const label = getTicketTypeLabel(type, t.label);

        const legs = Array.isArray(t.legs) ? t.legs : [];
        if (!legs.length) continue;

        let hasLose = false;
        let hasPending = false;
        let hasUnknown = false;
        let allWin = true;

        for (const leg of legs) {
          const fid = String(leg.fixture_id || "").trim();
          const pickText = String(leg.pick || "").trim();
          if (!fid && !pickText) {
            hasUnknown = true;
            allWin = false;
            continue;
          }
          const key = fid + "__" + pickText;
          const r = resultMap.get(key);
          const res = (r && r.result ? r.result : "UNKNOWN").toUpperCase();

          if (res === "LOSE") {
            hasLose = true;
            allWin = false;
          } else if (res === "WIN") {
          } else if (res === "PENDING") {
            hasPending = true;
            allWin = false;
          } else {
            hasUnknown = true;
            allWin = false;
          }
        }

        let status = "UNKNOWN";
        if (allWin) status = "WIN";
        else if (hasLose) status = "LOSE";
        else if (hasPending) status = "PENDING";
        else if (hasUnknown) status = "UNKNOWN";

        if (status !== "WIN" && status !== "LOSE") continue;

        const totalOdd = safeOdd(t.total_odd);
        const stake = 1;
        const profit = status === "WIN" ? (totalOdd - 1) : -1;

        const s = ensureType(type, label);
        s.played += 1;
        s.stake += stake;
        s.profit += profit;
        if (status === "WIN") s.wins += 1;
        if (status === "LOSE") s.loses += 1;

        globalStake += stake;
        globalProfit += profit;
        if (status === "WIN") globalWins += 1;
        if (status === "LOSE") globalLoses += 1;
      }

      const types = Object.keys(statsByType);
      if (!types.length) {
        container.innerHTML = `
          <div class="combo-summary-empty">
            Nessuna schedina chiusa (WIN/LOSE) nel periodo selezionato.
          </div>
        `;
        return;
      }

      const globalPlayed = globalWins + globalLoses;
      const globalWinrate =
        globalPlayed > 0 ? ((globalWins / globalPlayed) * 100).toFixed(1) : "-";
      const globalRoi =
        globalStake > 0 ? ((globalProfit / globalStake) * 100).toFixed(1) : "-";
      const roiClassGlobal =
        globalRoi === "-"
          ? "badge-neutral"
          : parseFloat(globalRoi) >= 0
          ? "badge-pos"
          : "badge-neg";

      let html = `<div class="combo-summary-grid">`;

      html += `
        <div class="combo-summary-card">
          <div class="combo-summary-title">Totale schedine</div>
          <div class="combo-summary-meta">
            <span>${globalPlayed} giocate · ${globalWins} win / ${globalLoses} lose</span>
          </div>
          <div class="combo-summary-meta">
            <span>Stake: ${globalStake} unità · Profitto: ${globalProfit.toFixed(2)} u</span>
          </div>
          <div class="combo-summary-meta">
            <span>Winrate: ${globalWinrate === "-" ? "-" : globalWinrate + "%"}</span>
            <span class="combo-summary-badge ${roiClassGlobal}">
              ROI: ${globalRoi === "-" ? "-" : globalRoi + "%"}
            </span>
          </div>
        </div>
      `;

      const order = ["X2", "X5", "X10", "X20"];
      types.sort((a, b) => {
        const ia = order.indexOf(a);
        const ib = order.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });

      for (const type of types) {
        const s = statsByType[type];
        const played = s.played;
        const wr =
          played > 0 ? ((s.wins / played) * 100).toFixed(1) : "-";
        const roi =
          s.stake > 0 ? ((s.profit / s.stake) * 100).toFixed(1) : "-";

        const roiClass =
          roi === "-"
            ? "badge-neutral"
            : parseFloat(roi) >= 0
            ? "badge-pos"
            : "badge-neg";

        html += `
          <div class="combo-summary-card">
            <div class="combo-summary-title">${s.label}</div>
            <div class="combo-summary-meta">
              <span>${played} schedine · ${s.wins} win / ${s.loses} lose</span>
            </div>
            <div class="combo-summary-meta">
              <span>Stake: ${s.stake} u · Profitto: ${s.profit.toFixed(2)} u</span>
            </div>
            <div class="combo-summary-meta">
              <span>Winrate: ${wr === "-" ? "-" : wr + "%"}</span>
              <span class="combo-summary-badge ${roiClass}">
                ROI: ${roi === "-" ? "-" : roi + "%"}
              </span>
            </div>
          </div>
        `;
      }

      html += `</div>`;
      container.innerHTML = html;
    } catch (err) {
      console.error("Errore storico combo:", err);
      container.innerHTML = `
        <div class="combo-summary-empty">
          Errore nel caricamento delle schedine.
        </div>
      `;
    }
  }

  const DAYS_FIXED = 30; // fisso, sempre 30 giorni

  document.addEventListener("DOMContentLoaded", () => {
    // init toggle
    applyRoiToggleUI();
    const bEvent = document.getElementById("roi-mode-event");
    const bPick = document.getElementById("roi-mode-pick");
    if (bEvent) bEvent.addEventListener("click", () => setRoiMode("event"));
    if (bPick) bPick.addEventListener("click", () => setRoiMode("pick"));

    loadHistory(DAYS_FIXED);
    // loadComboHistory(DAYS_FIXED); // disattivato: non mostriamo più lo storico schedine all'utente
  });
</script>

</body>
</html>
