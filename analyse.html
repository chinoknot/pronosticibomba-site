<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PB Analyzer</title>
  <style>
    :root{
      --bg0:#07101e; --bg1:#0a1628; --card:#0b1a2f; --txt:#e9f0ff; --muted:#a9b7d6;
      --line:rgba(255,255,255,.08); --accent:#3aa0ff; --accent2:#22c55e; --warn:#f59e0b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background: radial-gradient(1200px 900px at 85% 20%, rgba(58,160,255,.10) 0%, transparent 55%),
                  radial-gradient(900px 650px at 55% 25%, rgba(34,197,94,.10) 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1200px; margin:26px auto; padding:0 16px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    h1{margin:0; font-size:22px; letter-spacing:.2px;}
    .sub{color:var(--muted); font-size:13px; margin-top:4px;}
    .grid{display:grid; grid-template-columns: 380px 1fr; gap:14px; margin-top:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: rgba(11,26,47,.75);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 8px 26px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:10px; align-items:center;}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input[type="date"], input[type="text"]{
      width:100%; padding:10px 11px; border-radius:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--txt);
      outline:none;
    }
    input[type="text"]::placeholder{color:rgba(169,183,214,.6)}
    button{
      background: rgba(58,160,255,.16);
      color: var(--txt);
      border:1px solid rgba(58,160,255,.35);
      padding:10px 12px; border-radius:12px;
      cursor:pointer;
    }
    button:hover{background: rgba(58,160,255,.22)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .checks{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .chk{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted);}
    .chk input{accent-color: var(--accent);}
    .fixtures{margin-top:12px; max-height:360px; overflow:auto; padding-right:6px;}
    .fx{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 10px; border-radius:14px;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      margin-bottom:8px;
      cursor:pointer;
    }
    .fx:hover{background:rgba(255,255,255,.04)}
    .fx .l{min-width:0}
    .fx .t{font-weight:700; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .fx .m{font-size:12px; color:var(--muted); margin-top:2px;}
    .fx .r{font-family:var(--mono); font-size:12px; color:rgba(240,250,255,.86); white-space:nowrap;}
    .kv{display:grid; grid-template-columns: 160px 1fr; gap:8px; margin-top:10px;}
    .k{color:var(--muted); font-size:12px}
    .v{font-family:var(--mono); font-size:12px}
    .hr{height:1px; background:var(--line); margin:12px 0;}
    .prettyRow{display:grid; grid-template-columns: 1fr 220px; gap:10px; align-items:center; padding:6px 0;}
    .prettyTitle{font-weight:800; margin-bottom:6px;}
    .prettyBody{font-size:13px; line-height:1.35; color: rgba(240,250,255,.92);}
    .muted2{color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      margin-right:8px;
      white-space:nowrap;
    }
    .pill.safe{border-color: rgba(34,197,94,.38); background: rgba(34,197,94,.10)}
    .pill.med{border-color: rgba(245,158,11,.42); background: rgba(245,158,11,.10)}
    .pill.hard{border-color: rgba(244,63,94,.38); background: rgba(244,63,94,.10)}
    pre{
      margin:0; padding:12px; border-radius:14px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color: rgba(240,250,255,.9);
      overflow:auto; max-height:260px;
      font-size:12px;
    }
    .badge{display:inline-flex; align-items:center; gap:8px; font-size:12px; color:var(--muted)}
    .dot{width:8px; height:8px; border-radius:999px; background:var(--warn); box-shadow:0 0 12px rgba(245,158,11,.35);}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>PB Analyzer</h1>
      <div class="sub">Seleziona data e lega → scegli una partita → Analizza (goal/Poisson + esotiche: shots/corners/fouls/cards).</div>
    </div>
    <div class="badge"><span class="dot"></span><span id="backendLbl">Backend: n/d</span></div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div style="font-weight:800; margin-bottom:10px;">Fixture</div>

      <div class="row">
        <div style="flex:1">
          <label>Data</label>
          <input id="dateInp" type="date" />
        </div>
        <div style="width:120px; align-self:flex-end;">
          <button id="reloadBtn" style="width:100%;">Ricarica</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Ricerca</label>
        <input id="qInp" type="text" placeholder="es: Juventus, Arsenal, Lazio..." />
      </div>

      <div style="margin-top:10px;">
        <label>Leghe (maggiori)</label>
        <div class="checks">
          <label class="chk"><input type="checkbox" class="lg" value="135" checked> Serie A</label>
          <label class="chk"><input type="checkbox" class="lg" value="39" checked> Premier League</label>
          <label class="chk"><input type="checkbox" class="lg" value="140" checked> La Liga</label>
          <label class="chk"><input type="checkbox" class="lg" value="78" checked> Bundesliga</label>
          <label class="chk"><input type="checkbox" class="lg" value="61" checked> Ligue 1</label>
        </div>
        <div class="muted2" style="margin-top:6px;">Nota: qui lavoriamo solo sulle leghe maggiori. Minori le aggiungiamo dopo.</div>
      </div>

      <div class="muted2" style="margin-top:10px;">Mostrate <span id="countLbl">0</span> partite (filtrate).</div>

      <div id="fixtures" class="fixtures"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div style="font-weight:800; margin-bottom:10px;">Match selezionato</div>

      <div class="kv">
        <div class="k">Competizione</div><div class="v" id="selLeague">-</div>
        <div class="k">Kickoff (UTC)</div><div class="v" id="selKick">-</div>
        <div class="k">Match</div><div class="v" id="selMatch">-</div>
        <div class="k">Fixture ID</div><div class="v" id="selId">-</div>
      </div>

      <div class="hr"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="muted2">Endpoint usati: <span class="pill">GET /api/fixtures</span> <span class="pill">POST /api/analyze</span></div>
        <button id="anBtn" disabled>Analizza (step 1)</button>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:14px; align-items:stretch; flex-wrap:wrap;">
        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle">Output analisi (raw)</div>
          <pre id="rawOut">Seleziona una partita e premi Analizza.</pre>
        </div>
        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle">Note</div>
          <div class="prettyBody">
            <div>- Le esotiche arrivano dal backend come <b>exotics.totals</b> e <b>exotics.teams</b>.</div>
            <div>- Le quote vengono ignorate per decidere “se mostrare” (le useremo dopo solo per costruire bet builder / fallback).</div>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:14px; align-items:stretch; flex-wrap:wrap;">
        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle">Goal (Poisson)</div>
          <div class="prettyBody" id="goalBox">n/d</div>
        </div>

        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle">Esotiche (shots/corners/cards/fouls)</div>
          <div class="prettyBody" id="exoBox">n/d</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:14px; align-items:stretch; flex-wrap:wrap;">
        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle">Player (se disponibili)</div>
          <div class="prettyBody" id="playersBox">n/d</div>
        </div>

        <div class="card" style="flex:1; min-width:320px;">
          <div class="prettyTitle">PB Triple Builder (stimata)</div>
          <div class="prettyBody" id="betsBox">n/d</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted2">Backend attuale: <span id="backendFoot">n/d</span></div>
    </div>
  </div>
</div>

<script>
(function(){
  // ---- config ----
  var DEFAULT_BACKEND = "https://pb-analyzer-backend2.vercel.app";
  var backend = DEFAULT_BACKEND;

  // ---- state ----
  var allFixtures = [];
  var filteredFixtures = [];
  var selected = null;

  // ---- dom ----
  var dateInp = document.getElementById("dateInp");
  var qInp = document.getElementById("qInp");
  var reloadBtn = document.getElementById("reloadBtn");
  var fixturesEl = document.getElementById("fixtures");
  var countLbl = document.getElementById("countLbl");
  var anBtn = document.getElementById("anBtn");
  var rawOut = document.getElementById("rawOut");
  var backendLbl = document.getElementById("backendLbl");
  var backendFoot = document.getElementById("backendFoot");

  var selLeague = document.getElementById("selLeague");
  var selKick = document.getElementById("selKick");
  var selMatch = document.getElementById("selMatch");
  var selId = document.getElementById("selId");

  var goalBox = document.getElementById("goalBox");
  var exoBox = document.getElementById("exoBox");
  var playersBox = document.getElementById("playersBox");
  var betsBox = document.getElementById("betsBox");

  function setBackend(b){
    backend = b || DEFAULT_BACKEND;
    backendLbl.textContent = "Backend: " + backend;
    backendFoot.textContent = backend;
  }

  function pad2(n){ n = String(n||""); return n.length<2 ? ("0"+n) : n; }

  function todayISO(){
    var d = new Date();
    var y = d.getUTCFullYear();
    var m = pad2(d.getUTCMonth()+1);
    var da = pad2(d.getUTCDate());
    return y + "-" + m + "-" + da;
  }

  function fmtNum(x, d){
    if (d === undefined) d = 2;
    if (x === null || x === undefined) return "n/d";
    var n = Number(x);
    if (!isFinite(n)) return "n/d";
    return n.toFixed(d);
  }

  function pct(x, d){
    if (d === undefined) d = 1;
    if (x === null || x === undefined) return "n/d";
    var n = Number(x);
    if (!isFinite(n)) return "n/d";
    return (n*100).toFixed(d) + "%";
  }

  function safeGet(obj, pathArr){
    var cur = obj;
    for (var i=0;i<pathArr.length;i++){
      if (!cur) return undefined;
      cur = cur[pathArr[i]];
    }
    return cur;
  }

  function getCheckedLeagueIds(){
    var boxes = document.querySelectorAll("input.lg");
    var out = [];
    for (var i=0;i<boxes.length;i++){
      if (boxes[i].checked) out.push(boxes[i].value);
    }
    return out;
  }

  function pill(text, cls){
    var c = cls ? ("pill "+cls) : "pill";
    return '<span class="'+c+'">'+escapeHtml(text)+'</span>';
  }

  function escapeHtml(s){
    return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function renderFixtures(){
    fixturesEl.innerHTML = "";
    countLbl.textContent = String(filteredFixtures.length || 0);

    if (!filteredFixtures.length){
      fixturesEl.innerHTML = '<div class="muted2">Nessuna partita trovata.</div>';
      return;
    }

    for (var i=0;i<filteredFixtures.length;i++){
      (function(fx){
        var div = document.createElement("div");
        div.className = "fx";
        var left = document.createElement("div");
        left.className = "l";
        var t = document.createElement("div");
        t.className = "t";
        t.textContent = (fx.home_name + " vs " + fx.away_name);
        var m = document.createElement("div");
        m.className = "m";
        m.textContent = fx.league_name || "n/d";
        left.appendChild(t); left.appendChild(m);

        var right = document.createElement("div");
        right.className = "r";
        right.textContent = fx.kickoff_utc ? fx.kickoff_utc.replace("T"," ").replace("+00:00"," UTC") : "n/d";

        div.appendChild(left); div.appendChild(right);

        div.addEventListener("click", function(){
          selectFixture(fx);
        });

        fixturesEl.appendChild(div);
      })(filteredFixtures[i]);
    }
  }

  function applyFilters(){
    var q = (qInp.value || "").toLowerCase().trim();
    var leagues = getCheckedLeagueIds();

    filteredFixtures = allFixtures.filter(function(fx){
      if (leagues.length && leagues.indexOf(String(fx.league_id)) === -1) return false;
      if (!q) return true;
      var s = (fx.home_name + " " + fx.away_name + " " + (fx.league_name||"")).toLowerCase();
      return s.indexOf(q) !== -1;
    });

    renderFixtures();
  }

  function selectFixture(fx){
    selected = fx;
    selLeague.textContent = fx.league_name || "-";
    selKick.textContent = fx.kickoff_utc ? fx.kickoff_utc.replace("T"," ").replace("+00:00"," UTC") : "-";
    selMatch.textContent = fx.home_name + " vs " + fx.away_name;
    selId.textContent = String(fx.fixture_id || "-");
    anBtn.disabled = !fx.fixture_id;
    rawOut.textContent = "Pronto. Premi Analizza.";
    goalBox.textContent = "n/d";
    exoBox.textContent = "n/d";
    playersBox.textContent = "n/d";
    betsBox.textContent = "n/d";
  }

  function normalizeFixturesResponse(resp){
    // backend /api/fixtures dovrebbe tornare array di fixture.
    // Gestiamo alcuni formati possibili.
    if (!resp) return [];
    if (Array.isArray(resp)) return resp;
    if (Array.isArray(resp.response)) return resp.response;
    if (Array.isArray(resp.fixtures)) return resp.fixtures;
    return [];
  }

  function loadFixtures(){
    var date = dateInp.value || todayISO();
    dateInp.value = date;

    var leagueIds = getCheckedLeagueIds();
    var url = backend.replace(/\/$/,"") + "/api/fixtures?date=" + encodeURIComponent(date);
    if (leagueIds.length){
      url += "&league_ids=" + encodeURIComponent(leagueIds.join(","));
    }
    url += "&cb=" + Date.now();

    reloadBtn.disabled = true;
    fixturesEl.innerHTML = '<div class="muted2">Caricamento...</div>';

    fetch(url, { method:"GET" })
      .then(function(r){
        return r.json();
      })
      .then(function(data){
        var fx = normalizeFixturesResponse(data);
        // normalizza campi minimi attesi in UI
        allFixtures = fx.map(function(x){
          var homeName =
            safeGet(x, ["home","name"]) ||
            safeGet(x, ["home_name"]) ||
            safeGet(x, ["homeName"]) ||
            safeGet(x, ["teams","home","name"]) ||
            safeGet(x, ["teams","homeName"]) ||
            safeGet(x, ["homeTeam","name"]) ||
            safeGet(x, ["home"]) ||
            safeGet(x, ["team_home","name"]) ||
            "";

          var awayName =
            safeGet(x, ["away","name"]) ||
            safeGet(x, ["away_name"]) ||
            safeGet(x, ["awayName"]) ||
            safeGet(x, ["teams","away","name"]) ||
            safeGet(x, ["teams","awayName"]) ||
            safeGet(x, ["awayTeam","name"]) ||
            safeGet(x, ["away"]) ||
            safeGet(x, ["team_away","name"]) ||
            "";

          if (!homeName || !awayName) {
            var ms = String(
              safeGet(x, ["match"]) ||
              safeGet(x, ["title"]) ||
              safeGet(x, ["name"]) ||
              safeGet(x, ["fixture_title"]) ||
              ""
            );
            if (ms.indexOf(" vs ") > -1) {
              var p = ms.split(" vs ");
              if (!homeName) homeName = p[0] || homeName;
              if (!awayName) awayName = p[1] || awayName;
            } else if (ms.indexOf(" v ") > -1) {
              var p2 = ms.split(" v ");
              if (!homeName) homeName = p2[0] || homeName;
              if (!awayName) awayName = p2[1] || awayName;
            } else if (ms.indexOf(" - ") > -1) {
              var p3 = ms.split(" - ");
              if (!homeName) homeName = p3[0] || homeName;
              if (!awayName) awayName = p3[1] || awayName;
            }
          }

          return {
            fixture_id: safeGet(x, ["fixture_id"]) || safeGet(x, ["fixture","id"]) || safeGet(x, ["fixture","fixture_id"]) || safeGet(x, ["id"]),
            kickoff_utc: safeGet(x, ["kickoff_utc"]) || safeGet(x, ["fixture","date"]) || safeGet(x, ["kickoff"]) || safeGet(x, ["date"]),
            league_id: safeGet(x, ["league_id"]) || safeGet(x, ["league","id"]) || null,
            league: safeGet(x, ["league"]) || safeGet(x, ["league","name"]) || "",
            season: safeGet(x, ["season"]) || safeGet(x, ["league","season"]) || null,
            home_id: safeGet(x, ["home","id"]) || safeGet(x, ["teams","home","id"]) || safeGet(x, ["home_id"]) || null,
            away_id: safeGet(x, ["away","id"]) || safeGet(x, ["teams","away","id"]) || safeGet(x, ["away_id"]) || null,
            home_name: String(homeName || "").trim(),
            away_name: String(awayName || "").trim()
          };
        });
applyFilters();
        reloadBtn.disabled = false;
      })
      .catch(function(err){
        reloadBtn.disabled = false;
        fixturesEl.innerHTML = '<div class="muted2">Errore fixtures. Apri console.</div>';
        console.error("fixtures error:", err);
      });
  }

  // --- Poisson helpers ---
  function poissonP(k, lambda){
    // P(X=k) = e^-λ * λ^k / k!
    if (!(lambda>=0)) return null;
    if (!(k>=0)) return null;
    var p = Math.exp(-lambda);
    for (var i=1; i<=k; i++){
      p = p * (lambda / i);
    }
    return p;
  }

  function poissonCdf(k, lambda){
    var s = 0;
    for (var i=0;i<=k;i++){
      var p = poissonP(i, lambda);
      if (p === null) return null;
      s += p;
    }
    return s;
  }

  function pOver(threshold, lambda){
    // P(X > threshold)
    // threshold è tipo 1.5 -> quindi P(X >= 2)
    var k = Math.floor(threshold + 1e-9);
    var cdf = poissonCdf(k, lambda);
    if (cdf === null) return null;
    return 1 - cdf;
  }

  function renderGoals(model){
    if (!model) { goalBox.textContent = "n/d"; return; }
    var lt = model.lambda_total;
    var lh = model.lambda_home;
    var la = model.lambda_away;
    if (!(lt>=0)) { goalBox.textContent = "n/d"; return; }

    var html = "";
    html += '<div>λ totale: <b>'+fmtNum(lt,2)+'</b> (home '+fmtNum(lh,2)+' / away '+fmtNum(la,2)+')</div>';
    html += '<div style="margin-top:8px;">P Over 1.5 <b style="float:right">'+pct(pOver(1.5, lt),1)+'</b></div>';
    html += '<div style="margin-top:6px;">P Over 2.5 <b style="float:right">'+pct(pOver(2.5, lt),1)+'</b></div>';
    html += '<div style="margin-top:6px;">P Over 3.5 <b style="float:right">'+pct(pOver(3.5, lt),1)+'</b></div>';
    goalBox.innerHTML = html;
  }

  function renderExotics(exotics, fixture){
    if (!exotics || !exotics.totals){ exoBox.textContent="n/d"; return; }
    var t = exotics.totals;

    function row(label, obj){
      var mean = obj && obj.mean !== undefined ? obj.mean : null;
      var line = obj && obj.line !== undefined ? obj.line : null;
      return '<div class="prettyRow"><div>'+escapeHtml(label)+'</div><div style="text-align:right"><b>mean '+fmtNum(mean,2)+'</b> — line <b>'+ (line===null||line===undefined ? 'n/d' : fmtNum(line,1)) +'</b></div></div>';
    }

    var html = '';
    html += '<div class="muted2">Totali match (basati su ultimi match FT + confronto home_for vs away_against)</div>';
    html += '<div class="hr"></div>';
    html += row("Shots", t.shots_total);
    html += row("Shots on Target", t.sot_total);
    html += row("Corners", t.corners_total);
    html += row("Fouls", t.fouls_total);
    html += row("Cards (yellow)", t.cards_total);
    html += '<div class="hr"></div>';
    if (fixture && fixture.home && fixture.away){
      html += '<div class="muted2">Home/Away: '+escapeHtml(fixture.home.name)+' vs '+escapeHtml(fixture.away.name)+'</div>';
    }

    // season/recent avgs compat
    var th = safeGet(exotics, ["teams","home","season_avgs"]);
    var ta = safeGet(exotics, ["teams","away","season_avgs"]);
    if (th || ta){
      html += '<div class="muted2" style="margin-top:10px;">Season/Recent avgs (se disponibili):</div>';
      var lines = [];
      function kv(teamName, k, v){
        lines.push('<div class="prettyRow"><div>'+escapeHtml(teamName)+' — '+escapeHtml(k)+'</div><div style="text-align:right"><b>'+fmtNum(v,2)+'</b></div></div>');
      }
      if (th){
        kv(fixture.home.name, "corners_for_pg", th.corners_for_pg);
        kv(fixture.home.name, "corners_against_pg", th.corners_against_pg);
        kv(fixture.home.name, "fouls_for_pg", th.fouls_for_pg);
        kv(fixture.home.name, "fouls_against_pg", th.fouls_against_pg);
        kv(fixture.home.name, "shots_for_pg", th.shots_for_pg);
        kv(fixture.home.name, "sot_for_pg", th.sot_for_pg);
      }
      if (ta){
        kv(fixture.away.name, "corners_for_pg", ta.corners_for_pg);
        kv(fixture.away.name, "corners_against_pg", ta.corners_against_pg);
        kv(fixture.away.name, "fouls_for_pg", ta.fouls_for_pg);
        kv(fixture.away.name, "fouls_against_pg", ta.fouls_against_pg);
        kv(fixture.away.name, "shots_for_pg", ta.shots_for_pg);
        kv(fixture.away.name, "sot_for_pg", ta.sot_for_pg);
      }
      html += lines.join("");
    }

    if (exotics.meta){
      html += '<div class="muted2" style="margin-top:10px;">Nota: se qui vedi n/d, significa che backend ha risposto con null (non “problema UI”). Controlla in raw JSON: exotics.totals, exotics.teams, e ora anche exotics.meta.</div>';
    }

    exoBox.innerHTML = html;
  }

  function renderPlayers(exotics, fixture){
    var p = exotics && exotics.players;
    if (!p || (!p.home && !p.away)){ playersBox.textContent="n/d"; return; }

    function list(teamName, block){
      if (!block) return '';
      function one(title, arr, key){
        if (!arr || !arr.length) return '';
        var out = '<div class="muted2" style="margin-top:8px;">'+escapeHtml(title)+'</div>';
        for (var i=0;i<arr.length;i++){
          var it = arr[i];
          out += '<div>• '+escapeHtml(it.name)+' ('+escapeHtml(it.position||"")+') — '+escapeHtml(key)+': <b>'+fmtNum(it[key],2)+'</b> — g:'+escapeHtml(it.games)+'</div>';
        }
        return out;
      }
      var html = '<div style="font-weight:800; margin-bottom:6px;">'+escapeHtml(teamName)+'</div>';
      html += one("Top Shots", block.topShots, "shots_per_game");
      html += one("Top SoT", block.topSoT, "sot_per_game");
      html += one("Top Fouls", block.topFouls, "fouls_per_game");
      html += one("Top Cards", block.topCards, "yellow_per_game");
      return html;
    }

    var html = '';
    if (p.home && fixture && fixture.home) html += list(fixture.home.name, p.home);
    if (p.away && fixture && fixture.away) html += '<div class="hr"></div>' + list(fixture.away.name, p.away);

    playersBox.innerHTML = html || "n/d";
  }

  function renderBets(exotics){
    var bets = exotics && exotics.bets;
    if (!bets){ betsBox.textContent="n/d"; return; }

    function fmtOdds(x){
      if (typeof x !== 'number' || !isFinite(x)) return "n/d";
      return x.toFixed(2);
    }

    function renderOne(kind, obj){
      if (!obj) return '';
      var cls = kind === "easy" ? "safe" : (kind === "medium" ? "med" : "hard");
      // Backend uses est_total_odds + target (string). Keep compatibility with older keys.
      var quotaTxt = (typeof obj.est_total_odds === 'number' && isFinite(obj.est_total_odds))
        ? fmtOdds(obj.est_total_odds)
        : (typeof obj.target_odds === 'number' && isFinite(obj.target_odds) ? fmtOdds(obj.target_odds) : "n/d");
      var header = pill(obj.name || kind.toUpperCase(), cls)
        + '<span class="muted2">quota stimata <b>'+escapeHtml(quotaTxt)+'</b>'
        + (obj.target && typeof obj.target === 'string' ? ' <span class="muted2">('+escapeHtml(obj.target)+')</span>' : '')
        + '</span>';
      var html = '<div style="margin-top:8px;">'+header+'</div>';
      var legs = obj.legs || [];
      for (var i=0;i<legs.length;i++){
        var leg = legs[i] || {};
        var mkt = leg.market || leg.label || ("Leg "+(i+1));
        if (leg.team) mkt = mkt + " — " + String(leg.team);
        var note = leg.note || "";

        // Prefer showing the human selection (e.g. "Hermoso booked") for player legs.
        var right = "n/d";
        if (leg.selection) right = String(leg.selection);
        else if (leg.line !== null && leg.line !== undefined) right = fmtNum(leg.line, 1);

        // Append estimated odds if present.
        if (typeof leg.est_odds === 'number' && isFinite(leg.est_odds)){
          right += ' <span class="muted2">@'+fmtOdds(leg.est_odds)+'</span>';
        }

        // Append position context if present.
        var ctx = [];
        if (leg.position) ctx.push(leg.position);
        if (ctx.length) note = (note ? (note+" ") : "") + '['+ctx.join(' • ')+']';

        html += '<div class="prettyRow"><div>'+escapeHtml(mkt)+'</div><div style="text-align:right"><b>'+escapeHtml(right)+'</b> <span class="muted2">'+escapeHtml(note)+'</span></div></div>';
      }
      return html;
    }

    var html = '';
    html += renderOne("easy", bets.easy);
    html += '<div class="hr"></div>' + renderOne("medium", bets.medium);
    html += '<div class="hr"></div>' + renderOne("hard", bets.hard);
    betsBox.innerHTML = html;
  }

  function runAnalyze(){
    if (!selected || !selected.fixture_id) return;

    anBtn.disabled = true;
    rawOut.textContent = "Analisi in corso...";
    goalBox.textContent = "n/d";
    exoBox.textContent = "n/d";
    playersBox.textContent = "n/d";
    betsBox.textContent = "n/d";

    var url = backend.replace(/\/$/,"") + "/api/analyze?cb=" + Date.now();

    fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ fixture_id: selected.fixture_id })
    })
    .then(function(r){
      return r.json().then(function(j){ return { ok:r.ok, status:r.status, body:j }; });
    })
    .then(function(res){
      if (!res.ok){
        rawOut.textContent = JSON.stringify(res.body, null, 2);
        throw new Error("analyze "+res.status+" "+JSON.stringify(res.body));
      }
      var d = res.body;
      window.lastAnalysis = d;

      rawOut.textContent = JSON.stringify(d, null, 2);

      renderGoals(d.goals_model);
      renderExotics(d.exotics, d.fixture);
      renderPlayers(d.exotics, d.fixture);
      renderBets(d.exotics);

      anBtn.disabled = false;
    })
    .catch(function(err){
      console.error(err);
      rawOut.textContent = "Errore analisi. Apri console.";
      anBtn.disabled = false;
    });
  }

  // ---- events ----
  reloadBtn.addEventListener("click", function(){ loadFixtures(); });
  qInp.addEventListener("input", function(){ applyFilters(); });
  var leagueBoxes = document.querySelectorAll("input.lg");
  for (var i=0;i<leagueBoxes.length;i++){
    leagueBoxes[i].addEventListener("change", function(){ loadFixtures(); });
  }
  dateInp.addEventListener("change", function(){ loadFixtures(); });
  anBtn.addEventListener("click", function(){ runAnalyze(); });

  // ---- init ----
  setBackend(DEFAULT_BACKEND);
  dateInp.value = todayISO();
  loadFixtures();
})();
</script>
</body>
</html>
