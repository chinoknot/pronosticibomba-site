<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PB Analyzer</title>
  <style>
    :root{
      --bg:#07121a;
      --panel:rgba(255,255,255,0.06);
      --panel2:rgba(255,255,255,0.08);
      --text:#e8f0ff;
      --muted:rgba(232,240,255,0.65);
      --line:rgba(255,255,255,0.10);
      --accent:#58a6ff;
      --good:#2ecc71;
      --warn:#f39c12;
      --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Arial;
      background:radial-gradient(1200px 700px at 70% 20%, rgba(0,255,224,0.10), transparent 60%),
                 radial-gradient(900px 600px at 20% 10%, rgba(88,166,255,0.14), transparent 55%),
                 var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 40px}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      margin-bottom:14px
    }
    h1{margin:0;font-size:22px;letter-spacing:0.2px}
    .subtitle{margin-top:4px;color:var(--muted);font-size:13px}
    .statusRow{display:flex;gap:10px;align-items:center}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,0.15);font-size:12px;color:var(--muted)}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;background:var(--warn)}
    .dot.ok{background:var(--good)}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .cardHd{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid var(--line)}
    .cardHd b{font-size:14px}
    .cardBd{padding:14px}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="date"], input[type="text"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,0.18);color:var(--text);outline:none
    }
    input::placeholder{color:rgba(232,240,255,0.35)}

    .btn{
      border:1px solid rgba(88,166,255,0.35);
      background:rgba(88,166,255,0.12);
      color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600
    }
    .btn:disabled{opacity:0.55;cursor:not-allowed}
    .btnPrimary{background:rgba(88,166,255,0.22)}

    .leagues{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chk{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,0.12)}
    .chk input{accent-color:var(--accent)}
    .note{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.35}

    .list{margin-top:12px;border-top:1px solid var(--line)}
    .item{padding:10px 10px;border-bottom:1px solid var(--line);cursor:pointer;border-left:3px solid transparent}
    .item:hover{background:rgba(255,255,255,0.04)}
    .item.sel{border-left-color:var(--accent);background:rgba(88,166,255,0.06)}
    .item .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-bottom:3px}
    .item .title{font-weight:700}

    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
    .kv .k{color:var(--muted);font-size:12px}
    .kv .v{font-weight:700}
    .kvRow{padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.10)}

    .sectionTitle{margin:0 0 10px 0;font-size:14px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);background:rgba(0,0,0,0.10)}

    .bb{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 980px){.bb{grid-template-columns:1fr}}

    .box{background:var(--panel2);border:1px solid var(--line);border-radius:14px;padding:12px}
    .box h3{margin:0 0 8px 0;font-size:13px}

    table{width:100%;border-collapse:collapse}
    th,td{font-size:12px;padding:8px 8px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left}
    th{color:var(--muted);font-weight:700}
    .muted{color:var(--muted)}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:rgba(0,0,0,0.12);color:var(--muted)}
    .badge.good{border-color:rgba(46,204,113,0.35);color:#c9ffe0}
    .badge.warn{border-color:rgba(243,156,18,0.35);color:#ffe6b8}

    pre{white-space:pre-wrap;word-break:break-word;margin:0;color:rgba(232,240,255,0.80);font-size:12px;line-height:1.35}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>PB Analyzer</h1>
        <div class="subtitle">Seleziona data e lega, scegli una partita, poi Analizza. Focus: tiri, tiri in porta, corner, falli, cartellini + flag goal (solo se quota minima).</div>
      </div>
      <div class="statusRow">
        <div id="pillBackend" class="pill"><span id="dotBackend" class="dot"></span>Backend: <b id="backendTxt">...</b></div>
        <div class="pill">Fixture: <b id="fixtureCount">-</b></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHd">
          <b>Fixture</b>
          <button id="btnReload" class="btn">Ricarica</button>
        </div>
        <div class="cardBd">
          <label>Data</label>
          <input id="inpDate" type="date" />

          <label>Ricerca</label>
          <input id="inpSearch" type="text" placeholder="es: Juventus, Arsenal, Lazio..." />

          <label>Leghe (maggiori)</label>
          <div class="leagues" id="leagueWrap"></div>

          <div class="note">Nota: qui lavoriamo solo sulle leghe maggiori. Le minori le aggiungiamo dopo.</div>

          <div class="note" style="margin-top:10px"><b id="shownCount">Mostrate 0</b> partite (filtrate).</div>

          <div class="list" id="fixtureList"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHd">
          <b>Match selezionato</b>
          <button id="btnAnalyze" class="btn btnPrimary" disabled>Analizza</button>
        </div>
        <div class="cardBd">
          <div class="kv">
            <div class="kvRow k">Competizione</div><div class="kvRow v" id="selLeague">-</div>
            <div class="kvRow k">Kickoff (UTC)</div><div class="kvRow v" id="selKick">-</div>
            <div class="kvRow k">Match</div><div class="kvRow v" id="selMatch">-</div>
            <div class="kvRow k">Fixture ID</div><div class="kvRow v" id="selId">-</div>
          </div>

          <div class="chips" style="margin-top:14px">
            <span class="chip">GET /api/fixtures</span>
            <span class="chip">POST /api/analyze</span>
          </div>

          <div class="bb">
            <div class="box">
              <h3>Esotiche (suggerimenti)</h3>
              <div class="muted" style="font-size:12px;line-height:1.35">
                Mostriamo mercati esotici: tiri/tiri in porta (team e player), corner, falli, cartellini.
                Per il flag goal: mostriamo solo se tendenza alta e con vincolo quota minima.
              </div>
              <div id="exoticOut" style="margin-top:10px"></div>
            </div>

            <div class="box">
              <h3>Goal (solo flag, con vincoli quota)</h3>
              <div id="goalFlag"></div>
              <div class="muted" style="font-size:12px;line-height:1.35;margin-top:8px">
                Regole richieste:
                <ul style="margin:6px 0 0 18px;padding:0">
                  <li>Segnala goal solo se quota >= 1.80</li>
                  <li>Segnala Over solo se quota >= 1.90</li>
                </ul>
              </div>
            </div>
          </div>

          <div class="box" style="margin-top:12px">
            <h3>Output (raw)</h3>
            <pre id="raw">Seleziona una partita e premi Analizza.</pre>
          </div>

        </div>
      </div>
    </div>

  </div>

<script>
(function(){
  'use strict';

  // CONFIG
  var BACKEND = 'https://pb-analyzer-backend2.vercel.app';

  // DOM
  function el(id){ return document.getElementById(id); }
  var pillBackend = el('pillBackend');
  var dotBackend = el('dotBackend');
  var backendTxt = el('backendTxt');
  var fixtureCount = el('fixtureCount');
  var shownCount = el('shownCount');

  var inpDate = el('inpDate');
  var inpSearch = el('inpSearch');
  var btnReload = el('btnReload');
  var fixtureList = el('fixtureList');
  var leagueWrap = el('leagueWrap');

  var btnAnalyze = el('btnAnalyze');
  var selLeague = el('selLeague');
  var selKick = el('selKick');
  var selMatch = el('selMatch');
  var selId = el('selId');
  var raw = el('raw');
  var exoticOut = el('exoticOut');
  var goalFlag = el('goalFlag');

  var LEAGUES = [
    { id:'135', label:'Serie A', key:'seriea', checked:true },
    { id:'39',  label:'Premier League', key:'epl', checked:true },
    { id:'140', label:'La Liga', key:'laliga', checked:true },
    { id:'78',  label:'Bundesliga', key:'bundes', checked:true },
    { id:'61',  label:'Ligue 1', key:'ligue1', checked:true }
  ];

  var state = {
    fixtures: [],
    selected: null
  };

  function todayISO(){
    var d = new Date();
    var mm = String(d.getMonth()+1).padStart(2,'0');
    var dd = String(d.getDate()).padStart(2,'0');
    return d.getFullYear() + '-' + mm + '-' + dd;
  }

  function setBackend(ok){
    if(ok){
      dotBackend.className = 'dot ok';
      backendTxt.textContent = 'OK';
    } else {
      dotBackend.className = 'dot';
      backendTxt.textContent = 'KO';
    }
  }

  function qs(){
    return LEAGUES.filter(function(l){return l.checked;}).map(function(l){return l.id;});
  }

  function renderLeagues(){
    leagueWrap.innerHTML = '';
    LEAGUES.forEach(function(l){
      var lab = document.createElement('label');
      lab.className = 'chk';
      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!l.checked;
      cb.addEventListener('change', function(){ l.checked = cb.checked; applyFilter(); });
      var span = document.createElement('span');
      span.textContent = l.label;
      lab.appendChild(cb);
      lab.appendChild(span);
      leagueWrap.appendChild(lab);
    });
  }

  function safeText(x){ return (x===null||x===undefined)?'':String(x); }

  function applyFilter(){
    var q = (inpSearch.value||'').trim().toLowerCase();
    var allowed = qs();

    var list = state.fixtures.filter(function(f){
      var okLeague = allowed.indexOf(String(f.league_id||'')) >= 0 || allowed.indexOf(String(f.leagueId||'')) >= 0;
      if(!okLeague) return false;
      if(!q) return true;
      var s = (safeText(f.home)+' '+safeText(f.away)+' '+safeText(f.league)).toLowerCase();
      return s.indexOf(q) >= 0;
    });

    renderFixtureList(list);
  }

  function renderFixtureList(list){
    fixtureList.innerHTML = '';
    shownCount.textContent = 'Mostrate ' + list.length;
    fixtureCount.textContent = String(list.length);

    list.forEach(function(f){
      var div = document.createElement('div');
      div.className = 'item' + (state.selected && state.selected.fixture_id === f.fixture_id ? ' sel' : '');

      var meta = document.createElement('div');
      meta.className = 'meta';
      var left = document.createElement('span');
      left.textContent = safeText(f.league);
      var right = document.createElement('span');
      right.textContent = safeText(f.kickoff_utc).replace('T',' ').replace('Z',' UTC');
      meta.appendChild(left);
      meta.appendChild(right);

      var title = document.createElement('div');
      title.className = 'title';
      title.textContent = safeText(f.home) + ' vs ' + safeText(f.away);

      div.appendChild(meta);
      div.appendChild(title);

      div.addEventListener('click', function(){
        state.selected = f;
        btnAnalyze.disabled = false;
        selLeague.textContent = safeText(f.league);
        selKick.textContent = safeText(f.kickoff_utc).replace('T',' ').replace('Z',' UTC');
        selMatch.textContent = safeText(f.home) + ' vs ' + safeText(f.away);
        selId.textContent = safeText(f.fixture_id);
        raw.textContent = 'Pronto. Premi Analizza.';
        exoticOut.innerHTML = '';
        goalFlag.innerHTML = '';
        applyFilter();
      });

      fixtureList.appendChild(div);
    });
  }

  async function apiGet(path){
    var url = BACKEND + path;
    var res = await fetch(url, { method:'GET' });
    var data = await res.json();
    return data;
  }

  async function apiPost(path, body){
    var url = BACKEND + path;
    var res = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body||{})
    });
    var data = await res.json();
    return data;
  }

  function row(label, value){
    var tr = document.createElement('tr');
    var td1 = document.createElement('td');
    td1.textContent = label;
    var td2 = document.createElement('td');
    td2.textContent = value;
    tr.appendChild(td1);
    tr.appendChild(td2);
    return tr;
  }

  function renderExotics(exotics){
    if(!exotics){
      exoticOut.innerHTML = '<div class="muted">Nessun dato esotiche.</div>';
      return;
    }

    var blocks = [];

    function renderTable(title, arr){
      if(!arr || !arr.length) return;
      var box = document.createElement('div');
      box.style.marginTop = '10px';
      var h = document.createElement('div');
      h.style.fontWeight = '800';
      h.style.marginBottom = '8px';
      h.textContent = title;
      box.appendChild(h);

      var tbl = document.createElement('table');
      var thead = document.createElement('thead');
      var thr = document.createElement('tr');
      ['Mercato','Line','Conf 0-10','Note'].forEach(function(x){
        var th = document.createElement('th');
        th.textContent = x;
        thr.appendChild(th);
      });
      thead.appendChild(thr);
      tbl.appendChild(thead);

      var tb = document.createElement('tbody');
      arr.forEach(function(it){
        var tr = document.createElement('tr');
        var tdM = document.createElement('td'); tdM.textContent = safeText(it.market||it.label||'');
        var tdL = document.createElement('td'); tdL.textContent = safeText(it.line||it.threshold||it.value||'');
        var tdC = document.createElement('td'); tdC.textContent = safeText(it.confidence||it.conf||'');
        var tdN = document.createElement('td'); tdN.textContent = safeText(it.note||it.reason||'');
        tr.appendChild(tdM); tr.appendChild(tdL); tr.appendChild(tdC); tr.appendChild(tdN);
        tb.appendChild(tr);
      });
      tbl.appendChild(tb);
      box.appendChild(tbl);
      blocks.push(box);
    }

    // we accept any shape; try common keys
    renderTable('Tiri (team)', exotics.team_shots || exotics.shots_team || []);
    renderTable('Tiri in porta (team)', exotics.team_sot || exotics.shots_on_target_team || exotics.sot_team || []);
    renderTable('Tiri (player)', exotics.player_shots || []);
    renderTable('Tiri in porta (player)', exotics.player_sot || exotics.player_shots_on_target || []);
    renderTable('Corner', exotics.corners || []);
    renderTable('Falli (player)', exotics.player_fouls || exotics.fouls_player || []);
    renderTable('Cartellini (totali)', exotics.cards_total || []);
    renderTable('Cartellini (player)', exotics.player_cards || exotics.cards_player || []);

    if(blocks.length === 0){
      exoticOut.innerHTML = '<div class="muted">Nessun suggerimento esotico per questa partita.</div>';
      return;
    }
    exoticOut.innerHTML = '';
    blocks.forEach(function(b){ exoticOut.appendChild(b); });
  }

  function renderGoalFlag(goals){
    goalFlag.innerHTML = '';

    if(!goals){
      goalFlag.innerHTML = '<div class="muted">Nessun dato goal.</div>';
      return;
    }

    var high = !!(goals.high_goal_tendency || goals.highGoalTendency || goals.is_high_goal);
    var suggested = goals.suggested || goals.suggestions || [];

    var badge = document.createElement('span');
    badge.className = 'badge ' + (high ? 'good' : 'warn');
    badge.textContent = high ? 'Alta tendenza goal' : 'Tendenza goal non alta';
    goalFlag.appendChild(badge);

    if(!high) return;

    // Show only if it meets your minimum-odds constraints (we do not know real odds here, so we show the constraint text)
    var box = document.createElement('div');
    box.style.marginTop = '10px';
    box.className = 'muted';
    box.style.fontSize = '12px';
    box.style.lineHeight = '1.35';

    var txt = 'Possibile goal / over da considerare SOLO se quota minima rispettata (Goal>=1.80, Over>=1.90).';
    box.textContent = txt;
    goalFlag.appendChild(box);

    if(suggested && suggested.length){
      var ul = document.createElement('ul');
      ul.style.margin = '8px 0 0 18px';
      suggested.forEach(function(s){
        var li = document.createElement('li');
        li.textContent = safeText(s.market || s.label || s.type || '');
        ul.appendChild(li);
      });
      goalFlag.appendChild(ul);
    }
  }

  async function loadHealth(){
    try{
      var d = await apiGet('/api/health');
      setBackend(!!(d && d.ok));
    } catch(e){
      setBackend(false);
    }
  }

  async function loadFixtures(){
    var date = inpDate.value || todayISO();
    var url = '/api/fixtures?v=3&date=' + encodeURIComponent(date);

    raw.textContent = 'Carico fixtures...';

    var data;
    try{
      data = await apiGet(url);
    } catch(e){
      raw.textContent = 'Errore fetch fixtures.';
      return;
    }

    var fixtures = data.fixtures || [];
    state.fixtures = fixtures;

    applyFilter();
    raw.textContent = 'Fixture caricate.';
  }

  async function runAnalyze(){
    if(!state.selected){ return; }

    btnAnalyze.disabled = true;
    raw.textContent = 'Carico analisi...';
    exoticOut.innerHTML = '';
    goalFlag.innerHTML = '';

    try{
      var resp = await apiPost('/api/analyze', { fixture_id: state.selected.fixture_id });
      raw.textContent = JSON.stringify(resp, null, 2);

      // expected: { ok:true, version:'analyze-v2', goals_model:{}, exotics:{} }
      renderGoalFlag(resp.goals_model || resp.goals || null);
      renderExotics(resp.exotics || null);

    } catch(e){
      raw.textContent = 'Errore analisi.';
    } finally {
      btnAnalyze.disabled = false;
    }
  }

  // INIT
  inpDate.value = todayISO();
  renderLeagues();

  btnReload.addEventListener('click', function(){ loadFixtures(); });
  inpSearch.addEventListener('input', function(){ applyFilter(); });
  btnAnalyze.addEventListener('click', function(){ runAnalyze(); });

  loadHealth().then(loadFixtures);
})();
</script>

</body>
</html>
