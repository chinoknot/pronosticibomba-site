<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PB Analyzer</title>
  <style>
    :root{
      --bg0:#07101e;
      --bg1:#0a1628;
      --card:#0b1a2f;
      --txt:#e9f0ff;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.08);
      --accent:#3aa0ff;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--txt);
      background: radial-gradient(1200px 700px at 20% 10%, #0d2b4f 0%, transparent 60%),
                  radial-gradient(900px 650px at 85% 20%, #0b3a2f 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    header{
      padding:22px 22px 12px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
    }
    .brand{font-size:20px;font-weight:700;letter-spacing:.2px;}
    .sub{margin-top:4px;color:var(--muted);font-size:12px;}
    .status{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center;white-space:nowrap;}
    .pillWrap{padding:6px 10px;border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:999px;display:inline-flex;gap:8px;align-items:center;}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--warn)}
    .dot.ok{background:var(--accent2)}
    main{padding:0 22px 24px;}
    .grid{display:grid;grid-template-columns: 380px 1fr;gap:14px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: 0 8px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .card h3{
      margin:0;padding:14px 14px 10px;border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.08);font-size:13px;letter-spacing:.2px;font-weight:700;
    }
    .card .body{padding:14px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input[type="date"], input[type="text"]{
      padding:10px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--txt);outline:none;
    }
    input[type="text"]{width:100%}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--txt);cursor:pointer;font-weight:600;
    }
    .btn.primary{border-color:rgba(58,160,255,.35);background:rgba(58,160,255,.16);}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .leagues{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;}
    .chk{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12);user-select:none;}
    .chk input{accent-color:var(--accent)}
    .note{margin-top:10px;color:var(--muted);font-size:12px}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto;padding-right:4px;}
    .item{padding:12px;border:1px solid var(--line);background:rgba(0,0,0,.14);border-radius:14px;cursor:pointer;}
    .item:hover{border-color:rgba(58,160,255,.35)}
    .item.active{border-color:rgba(58,160,255,.55); background:rgba(58,160,255,.10)}
    .item .top{display:flex;justify-content:space-between;color:var(--muted);font-size:11px;gap:10px;}
    .item .mid{margin-top:6px;font-size:14px;font-weight:800;letter-spacing:.2px;}
    .kv{display:grid;grid-template-columns: 140px 1fr;gap:10px;margin:0;}
    .kv div{padding:10px 12px;border:1px solid var(--line);background:rgba(0,0,0,.12);border-radius:12px;font-size:12px;}
    .k{color:var(--muted)}
    .v{font-family:var(--mono);font-size:12px}
    .muted{color:var(--muted)}
    .box{padding:12px;border:1px solid var(--line);background:rgba(0,0,0,.12);border-radius:12px;}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;font-family:var(--mono);font-size:12px;color:#dbe6ff;}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
    @media (max-width:980px){.split{grid-template-columns:1fr}}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12);font-size:12px;color:var(--muted);}
    .badge b{color:var(--txt)}
    footer{padding:12px 22px 22px;color:var(--muted);font-size:12px;}

    /* Step 2: pretty output */
    .hidden{ display:none; }
    .pretty{ margin-top:12px; }
    .prettyRow{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width: 980px){ .prettyRow{ grid-template-columns: 1fr 1fr; } }
    .prettyCard{ background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:12px; }
    .prettyTitle{ font-weight:700; letter-spacing:.2px; margin-bottom:8px; opacity:.95; }
    .prettyBody{ font-size:13px; line-height:1.35; color: rgba(240,250,255,0.92); }
    .prettyBody.small{ font-size:12px; opacity:.9; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; margin:6px 6px 0 0; font-size:12px;
           border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.18); }
    .pill.good{ border-color: rgba(60, 220, 130, 0.35); }
    .pill.warn{ border-color: rgba(255, 190, 60, 0.35); }
    .pill.bad{ border-color: rgba(255, 80, 80, 0.35); opacity:.75; }
    .kv2{ display:grid; grid-template-columns: 220px 1fr; gap:6px 10px; margin-top:8px; }
    .kv2 div{ padding:2px 0; }
    .muted2{ opacity:.8; }
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0;}
    .mono{font-family:var(--mono)}
  </style>
</head>
<body>
<header>
  <div>
    <div class="brand">PB Analyzer</div>
    <div class="sub">Seleziona data e lega → scegli una partita → Analizza (goal/Poisson/Under-Over). Poi aggiungiamo cards/corners/shots + screenshot.</div>
  </div>
  <div class="status">
    <span class="pillWrap"><span id="dot" class="dot"></span><span id="backendTxt">Backend: ...</span></span>
    <span class="pillWrap">Fixture: <b id="fixtureCount">-</b></span>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h3>Fixture</h3>
      <div class="body">
        <div class="row" style="justify-content:space-between;align-items:flex-end;">
          <div style="flex:1;min-width:180px;">
            <label for="dateInp">Data</label><br/>
            <input id="dateInp" type="date" />
          </div>
          <button id="btnReload" class="btn primary">Ricarica</button>
        </div>

        <div style="margin-top:10px;">
          <label for="searchInp">Ricerca</label><br/>
          <input id="searchInp" type="text" placeholder="es: Juventus, Arsenal, Lazio..." />
        </div>

        <div style="margin-top:10px;">
          <label>Leghe (maggiori)</label>
          <div class="leagues">
            <label class="chk"><input type="checkbox" class="lg" value="135" checked /> Serie A</label>
            <label class="chk"><input type="checkbox" class="lg" value="39" checked /> Premier League</label>
            <label class="chk"><input type="checkbox" class="lg" value="140" checked /> La Liga</label>
            <label class="chk"><input type="checkbox" class="lg" value="78" checked /> Bundesliga</label>
            <label class="chk"><input type="checkbox" class="lg" value="61" checked /> Ligue 1</label>
          </div>
          <div class="note">Nota: qui lavoriamo solo sulle leghe maggiori. Minori le aggiungiamo dopo.</div>
        </div>

        <div class="note" style="margin-top:12px;">Mostrate <b id="shownCount">0</b> partite (filtrate).</div>
        <div id="fixturesList" class="list"></div>
      </div>
    </section>

    <section class="card">
      <h3>Match selezionato</h3>
      <div class="body">
        <div class="kv">
          <div class="k">Competizione</div><div class="v" id="selLeague">-</div>
          <div class="k">Kickoff (UTC)</div><div class="v" id="selKick">-</div>
          <div class="k">Match</div><div class="v" id="selMatch">-</div>
          <div class="k">Fixture ID</div><div class="v" id="selId">-</div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:12px;">
          <button id="btnAnalyze" class="btn primary" disabled>Analizza (prossimo step)</button>
        </div>

        <div class="note">
          Endpoint usati:
          <span class="badge"><b>GET</b> /api/fixtures</span>
          <span class="badge"><b>POST</b> /api/analyze</span>
        </div>

        <div class="split">
          <div class="box">
            <div class="muted" style="margin-bottom:8px;"><b>Output analisi (raw)</b></div>
            <pre id="analyzeRaw">Seleziona una partita e premi Analizza.</pre>

            <div id="analyzePretty" class="pretty hidden">
              <div class="prettyRow">
                <div class="prettyCard">
                  <div class="prettyTitle">Goal (Poisson)</div>
                  <div id="goalSummary" class="prettyBody"></div>
                </div>
                <div class="prettyCard">
                  <div class="prettyTitle">Esotiche (shots/corners/cards/fouls)</div>
                  <div id="exoticTeam" class="prettyBody"></div>
                </div>
              </div>

              <div class="prettyRow">
                <div class="prettyCard">
                  <div class="prettyTitle">Player (se disponibili)</div>
                  <div id="exoticPlayers" class="prettyBody"></div>
                </div>
                <div class="prettyCard">
                  <div class="prettyTitle">Debug</div>
                  <div id="debugBox" class="prettyBody small"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="box">
            <div class="muted" style="margin-bottom:8px;"><b>Note</b></div>
            <div class="muted" style="font-size:12px;line-height:1.35">
              - Ora stampiamo JSON. Nel prossimo step lo trasformiamo in:
              <br/>• tabella medie gol + under/over
              <br/>• Poisson (U/O 3.5) + confidenza 0–10
              <br/>• suggerimento soglia value (1.5/2.5/3.5)
              <br/><br/>Poi aggiungiamo shots/corners/cards e upload screenshot lineups.
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>
  Backend attuale: <span class="muted" id="backendUrlTxt"></span>
</footer>

<script>
(() => {
  const BACKEND = "https://pb-analyzer-backend2.vercel.app";
  const els = {
    dot: document.getElementById("dot"),
    backendTxt: document.getElementById("backendTxt"),
    backendUrlTxt: document.getElementById("backendUrlTxt"),
    fixtureCount: document.getElementById("fixtureCount"),
    shownCount: document.getElementById("shownCount"),
    dateInp: document.getElementById("dateInp"),
    searchInp: document.getElementById("searchInp"),
    btnReload: document.getElementById("btnReload"),
    fixturesList: document.getElementById("fixturesList"),
    selLeague: document.getElementById("selLeague"),
    selKick: document.getElementById("selKick"),
    selMatch: document.getElementById("selMatch"),
    selId: document.getElementById("selId"),
    btnAnalyze: document.getElementById("btnAnalyze"),
    analyzeRaw: document.getElementById("analyzeRaw"),
  };

  let allFixtures = [];
  let selected = null;

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function setBackendStatus(ok){
    els.dot.classList.toggle("ok", !!ok);
    els.backendTxt.textContent = ok ? "Backend: OK" : "Backend: KO";
    els.backendUrlTxt.textContent = BACKEND;
  }

  async function ping(){
    try{
      const res = await fetch(`${BACKEND}/api/health`, { method:"GET" });
      setBackendStatus(res.ok);
    }catch(e){
      setBackendStatus(false);
    }
  }

  function getSelectedLeagueIds(){
    return Array.from(document.querySelectorAll("input.lg"))
      .filter(x => x.checked)
      .map(x => x.value);
  }

  function clearSelection(){
    selected = null;
    els.selLeague.textContent = "-";
    els.selKick.textContent = "-";
    els.selMatch.textContent = "-";
    els.selId.textContent = "-";
    els.btnAnalyze.disabled = true;
  }

  function setSelection(f){
    selected = f;
    els.selLeague.textContent = f.league || "-";
    els.selKick.textContent = String(f.kickoff_utc || "-").replace("T"," ").replace(":00+00:00"," UTC");
    els.selMatch.textContent = `${f.home} vs ${f.away}`;
    els.selId.textContent = String(f.fixture_id || "-");
    els.btnAnalyze.disabled = !f.fixture_id;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderList(){
    const q = (els.searchInp.value || "").trim().toLowerCase();
    const allowed = new Set(getSelectedLeagueIds());

    const filtered = allFixtures.filter(f => {
      if (allowed.size && f.league_id && !allowed.has(String(f.league_id))) return false;
      if (!q) return true;
      const hay = `${f.home} ${f.away} ${f.league}`.toLowerCase();
      return hay.includes(q);
    });

    els.shownCount.textContent = String(filtered.length);
    els.fixturesList.innerHTML = "";

    filtered.forEach(f => {
      const div = document.createElement("div");
      div.className = "item" + (selected && selected.fixture_id === f.fixture_id ? " active" : "");
      const when = String(f.kickoff_utc || "").replace("T"," ").replace(":00+00:00"," UTC");
      div.innerHTML = `
        <div class="top">
          <span>${escapeHtml(f.league || "")}</span>
          <span>${escapeHtml(when)}</span>
        </div>
        <div class="mid">${escapeHtml(f.home || "")} vs ${escapeHtml(f.away || "")}</div>
      `;
      div.addEventListener("click", () => {
        setSelection(f);
        renderList();
      });
      els.fixturesList.appendChild(div);
    });

    if (filtered.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.padding = "10px 2px";
      empty.textContent = "Nessuna partita trovata per questa data/filtri.";
      els.fixturesList.appendChild(empty);
    }
  }

  async function loadFixtures(){
    clearSelection();
    els.fixturesList.innerHTML = `<div class="muted">Carico fixture...</div>`;
    els.fixtureCount.textContent = "-";
    els.shownCount.textContent = "0";

    const date = els.dateInp.value || todayISO();
    try{
      const res = await fetch(`${BACKEND}/api/fixtures?v=3&date=${encodeURIComponent(date)}`, { method:"GET" });
      if (!res.ok) throw new Error(`fixtures ${res.status}`);
      const data = await res.json();
      allFixtures = Array.isArray(data.fixtures) ? data.fixtures : [];
      els.fixtureCount.textContent = String(allFixtures.length);
      renderList();
    }catch(e){
      els.fixturesList.innerHTML = `<div class="muted">Errore caricamento fixture. Apri console.</div>`;
      console.error(e);
    }
  }

  function pct(x){ if (typeof x !== "number" || !isFinite(x)) return "-"; return (x*100).toFixed(1) + "%"; }
  function fmt(x, d=2){ if (typeof x !== "number" || !isFinite(x)) return "-"; return x.toFixed(d); }

  function poissonPMF(k, lambda){
    if (lambda <= 0) return k === 0 ? 1 : 0;
    let p = Math.exp(-lambda);
    for (let i=1;i<=k;i++) p *= lambda / i;
    return p;
  }
  function poissonCDF(k, lambda){
    let s = 0;
    for (let i=0;i<=k;i++) s += poissonPMF(i, lambda);
    return s;
  }
  function poissonOver(threshold, lambda){
    return 1 - poissonCDF(threshold, lambda);
  }

  function pill(text, kind="good"){
    const cls = `pill ${kind||""}`.trim();
    return `<span class="${cls}">${text}</span>`;
  }

  function renderAnalysis(data){
    const pretty = document.getElementById("analyzePretty");
    const goalBox = document.getElementById("goalSummary");
    const teamBox = document.getElementById("exoticTeam");
    const playersBox = document.getElementById("exoticPlayers");
    const debugBox = document.getElementById("debugBox");
    if (!pretty || !goalBox || !teamBox || !playersBox) return;

    goalBox.innerHTML = "";
    teamBox.innerHTML = "";
    playersBox.innerHTML = "";
    if (debugBox) debugBox.innerHTML = "";

    // ---- GOALS (Poisson) ----
    const gm = data?.goals_model || {};
    const lamH = gm.lambda_home ?? gm.home_lambda ?? gm.mu_home ?? null;
    const lamA = gm.lambda_away ?? gm.away_lambda ?? gm.mu_away ?? null;
    const lamT = (typeof lamH === "number" && typeof lamA === "number") ? (lamH + lamA) : (gm.lambda_total ?? gm.mu_total ?? null);

    let goalHtml = "";
    if (typeof lamT === "number" && isFinite(lamT)){
      const pOver15 = poissonOver(1, lamT);
      const pOver25 = poissonOver(2, lamT);
      const pOver35 = poissonOver(3, lamT);

      goalHtml += `<div class="muted2">λ totale: <b>${fmt(lamT,2)}</b>${(typeof lamH==="number" && typeof lamA==="number") ? ` (home ${fmt(lamH,2)} / away ${fmt(lamA,2)})` : ""}</div>`;
      goalHtml += `<div class="kv2" style="margin-top:8px">
        <div class="muted2">P Over 1.5</div><div>${pct(pOver15)}</div>
        <div class="muted2">P Over 2.5</div><div>${pct(pOver25)}</div>
        <div class="muted2">P Over 3.5</div><div>${pct(pOver35)}</div>
      </div>`;
    }else{
      goalHtml += `<div class="muted2">Goal model non disponibile per questa partita (o schema diverso).</div>`;
    }
    goalBox.innerHTML = goalHtml;

    // ---- EXOTICS TOTALS (FIX) ----
    const ex = data?.exotics || {};
    const totals = ex?.totals || {};
    // helper per leggere mean/line da oggetti tipo {mean, line} o campi alternativi
    const readMean = (obj) => {
      if (!obj || typeof obj !== "object") return null;
      const v = obj.mean ?? obj.avg ?? obj.average ?? obj.mu ?? obj.value ?? null;
      return (typeof v === "number" && isFinite(v)) ? v : null;
    };
    const readLine = (obj) => {
      if (!obj || typeof obj !== "object") return null;
      const v = obj.line ?? obj.suggested_line ?? obj.recommended_line ?? obj.threshold ?? null;
      if (typeof v === "number" && isFinite(v)) return String(v);
      if (typeof v === "string" && v.trim()) return v.trim();
      return null;
    };

    const shotsObj   = totals.shots_total   ?? totals.shots ?? totals.total_shots ?? null;
    const sotObj     = totals.sot_total     ?? totals.shots_on_target_total ?? totals.sot ?? totals.total_sot ?? null;
    const cornersObj = totals.corners_total ?? totals.corners ?? totals.total_corners ?? null;
    const foulsObj   = totals.fouls_total   ?? totals.fouls ?? totals.total_fouls ?? null;
    const cardsObj   = totals.cards_total   ?? totals.cards ?? totals.total_cards ?? null;

    const shotsMean   = readMean(shotsObj);
    const sotMean     = readMean(sotObj);
    const cornersMean = readMean(cornersObj);
    const foulsMean   = readMean(foulsObj);
    const cardsMean   = readMean(cardsObj);

    const shotsLine   = readLine(shotsObj);
    const sotLine     = readLine(sotObj);
    const cornersLine = readLine(cornersObj);
    const foulsLine   = readLine(foulsObj);
    const cardsLine   = readLine(cardsObj);

    const anyTotals =
      shotsObj || sotObj || cornersObj || foulsObj || cardsObj ||
      shotsMean!=null || sotMean!=null || cornersMean!=null || foulsMean!=null || cardsMean!=null;

    let teamHtml = "";
    if (!anyTotals){
      teamHtml = `<div class="muted2">Totali match non presenti nella risposta per questa partita.</div>`;
    }else{
      teamHtml += `<div class="muted2"><b>Totali match</b> (basati su stats stagionali + confronto squadre)</div>`;
      teamHtml += `<div class="hr"></div>`;
      teamHtml += `<div class="kv2 mono">
        <div class="muted2">Shots</div>
        <div>mean ${shotsMean!=null?fmt(shotsMean,2):"n/d"} — line ${shotsLine!=null?escapeHtml(shotsLine):"n/d"}</div>

        <div class="muted2">Shots on Target</div>
        <div>mean ${sotMean!=null?fmt(sotMean,2):"n/d"} — line ${sotLine!=null?escapeHtml(sotLine):"n/d"}</div>

        <div class="muted2">Corners</div>
        <div>mean ${cornersMean!=null?fmt(cornersMean,2):"n/d"} — line ${cornersLine!=null?escapeHtml(cornersLine):"n/d"}</div>

        <div class="muted2">Fouls</div>
        <div>mean ${foulsMean!=null?fmt(foulsMean,2):"n/d"} — line ${foulsLine!=null?escapeHtml(foulsLine):"n/d"}</div>

        <div class="muted2">Cards (yellow)</div>
        <div>${cardsMean!=null?`mean ${fmt(cardsMean,2)} — line ${cardsLine!=null?escapeHtml(cardsLine):"n/d"}`:"n/d"}</div>
      </div>`;

      // Home/Away label se presente (solo testo)
      const fx = data?.fixture || {};
      const homeName = fx?.home?.name || fx?.teams?.home?.name || "";
      const awayName = fx?.away?.name || fx?.teams?.away?.name || "";
      if (homeName || awayName){
        teamHtml += `<div class="hr"></div>`;
        teamHtml += `<div class="muted2">Home/Away: ${escapeHtml(homeName)} vs ${escapeHtml(awayName)}</div>`;
      }
    }
    teamBox.innerHTML = teamHtml;

    // ---- PLAYERS (già ok) ----
    // Supporta sia schema "flat" sia schema {home:{topShots...},away:{topShots...}}
    const px = ex?.players || {};
    function renderPlayerBlock(sideLabel, sideObj){
      if (!sideObj || typeof sideObj !== "object") return "";
      const topShots = Array.isArray(sideObj.topShots) ? sideObj.topShots : [];
      const topSoT = Array.isArray(sideObj.topSoT) ? sideObj.topSoT : [];
      const topFouls = Array.isArray(sideObj.topFouls) ? sideObj.topFouls : [];
      const topCards = Array.isArray(sideObj.topCards) ? sideObj.topCards : [];

      const li = (arr, key) => arr.slice(0,5).map(p => {
        const name = p?.name || "Player";
        const pos = p?.position ? `(${p.position})` : "";
        const g = (typeof p?.games === "number") ? `g:${p.games}` : "";
        const v = (typeof p?.[key] === "number") ? fmt(p[key],2) : "n/d";
        return `<div>• ${escapeHtml(name)} ${escapeHtml(pos)} — ${key}: ${v} ${g?`— ${g}`:""}</div>`;
      }).join("");

      let out = `<div class="muted2"><b>${escapeHtml(sideLabel)}</b></div>`;
      if (topShots.length){ out += `<div class="hr"></div><div><b>Top Shots</b></div>${li(topShots,"shots_per_game")}`; }
      if (topSoT.length){ out += `<div class="hr"></div><div><b>Top SoT</b></div>${li(topSoT,"sot_per_game")}`; }
      if (topFouls.length){ out += `<div class="hr"></div><div><b>Top Fouls</b></div>${li(topFouls,"fouls_per_game")}`; }
      if (topCards.length){ out += `<div class="hr"></div><div><b>Top Cards</b></div>${li(topCards,"yellow_per_game")}`; }
      return out;
    }

    let playersHtml = "";
    if (px?.home || px?.away){
      const homeTeam = data?.fixture?.home?.name || data?.fixture?.teams?.home?.name || "Home";
      const awayTeam = data?.fixture?.away?.name || data?.fixture?.teams?.away?.name || "Away";
      playersHtml += renderPlayerBlock(homeTeam, px.home);
      playersHtml += `<div class="hr"></div>`;
      playersHtml += renderPlayerBlock(awayTeam, px.away);
    }else if (Array.isArray(ex?.players) && ex.players.length){
      playersHtml = `<div class="muted2">Players presenti ma schema diverso (array). Debug nel raw.</div>`;
    }else{
      playersHtml = `<div class="muted2">Player non disponibili per questa partita.</div>`;
    }
    playersBox.innerHTML = playersHtml;

    // ---- DEBUG ----
    if (debugBox){
      const v = data?.version || "-";
      const fid = data?.fixture?.fixture_id || data?.fixture?.id || selected?.fixture_id || "-";
      debugBox.innerHTML = `<div class="kv2">
        <div class="muted2">Version</div><div>${escapeHtml(v)}</div>
        <div class="muted2">Fixture ID</div><div>${escapeHtml(fid)}</div>
        <div class="muted2">Backend</div><div>${escapeHtml(BACKEND)}</div>
      </div>`;
    }

    pretty.classList.remove("hidden");
  }

  async function runAnalyze(){
    if (!selected || !selected.fixture_id) return;
    els.analyzeRaw.textContent = "Analisi in corso...";
    try{
      const res = await fetch(`${BACKEND}/api/analyze`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ fixture_id: selected.fixture_id })
      });
      if (!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`analyze ${res.status} ${t}`);
      }
      const data = await res.json();
      window.lastAnalysis = data;
      els.analyzeRaw.textContent = JSON.stringify(data, null, 2);
      renderAnalysis(data);
    }catch(e){
      console.error(e);
      els.analyzeRaw.textContent = "Errore analisi. Apri console.";
      const pretty = document.getElementById("analyzePretty");
      if (pretty) pretty.classList.add("hidden");
    }
  }

  // init
  els.dateInp.value = todayISO();
  els.searchInp.addEventListener("input", () => renderList());
  document.querySelectorAll("input.lg").forEach(chk => chk.addEventListener("change", () => renderList()));
  els.btnReload.addEventListener("click", () => loadFixtures());
  els.btnAnalyze.addEventListener("click", () => runAnalyze());

  ping().then(loadFixtures);
})();
</script>
</body>
</html>
