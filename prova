<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Storico Pronostici – Pronostici Bomba</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #050816;
      --card: #020617;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border: rgba(148, 163, 184, 0.2);
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.18);
      --shadow-soft: 0 20px 45px rgba(15, 23, 42, 0.9);
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #1e293b, var(--bg));
      color: var(--text-main);
    }

    main {
      max-width: 1180px;
      margin: 32px auto 40px;
      padding: 0 20px 40px;
    }

    h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    header { margin-bottom: 24px; }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .back-link {
      color: var(--text-muted);
      text-decoration: none;
      padding: 4px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 0.83rem;
    }

    .subtitle {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--text-muted);
      max-width: 750px;
      line-height: 1.45;
    }

    .controls {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    select {
      background: var(--card);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 12px;
    }

    /* SUMMARY */
    .summary-row {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 14px;
    }

    .summary-card {
      background: linear-gradient(to bottom right, rgba(249, 115, 22, 0.05), var(--card));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: var(--shadow-soft);
    }

    .summary-label {
      font-size: 0.75rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .summary-value {
      font-size: 1.45rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .summary-detail {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* CATEGORY CARDS */
    #category-summary {
      margin-top: 26px;
    }

    .cat-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .cat-sub {
      font-size: 0.82rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .cat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .cat-card {
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.88));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: var(--shadow-soft);
    }

    .cat-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .cat-metric-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .cat-metric-value {
      font-size: 1rem;
      font-weight: 600;
    }

    .cm-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
    }

    .pos { color: #bbf7d0; }
    .neg { color: #fecaca; }
    .neu { color: var(--text-muted); }

    /* TABLE */
    .table-wrapper {
      margin-top: 20px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }

    th {
      text-align: left;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    td { color: var(--text-main); }

    .empty {
      padding: 20px;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-muted);
    }
  </style>
</head>

<body>
  <main>
    <header>
      <div class="top-row">
        <h1>Storico pronostici</h1>
        <a class="back-link" href="/index.html">← Torna ai pronostici</a>
      </div>

      <p class="subtitle">
        Panoramica automatica su winrate e ROI, calcolata sui risultati ufficiali delle partite.
        Le partite non concluse o con esito non disponibile non vengono conteggiate.
      </p>

      <div class="controls">
        <span>Intervallo:</span>
        <select id="range-select">
          <option value="7">Ultimi 7 giorni</option>
          <option value="14" selected>Ultimi 14 giorni</option>
          <option value="30">Ultimi 30 giorni</option>
        </select>
      </div>

      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Periodo</div>
          <div class="summary-value" id="summary-period">-</div>
          <div class="summary-detail" id="summary-days">-</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Winrate totale</div>
          <div class="summary-value" id="summary-winrate">-</div>
          <div class="summary-detail" id="summary-wl">-</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">ROI totale</div>
          <div class="summary-value" id="summary-roi">-</div>
          <div class="summary-detail" id="summary-profit">-</div>
        </div>
      </div>

      <section id="category-summary"></section>
    </header>

    <section id="table-container">
      <div class="table-wrapper">
        <div class="empty">Caricamento storico…</div>
      </div>
    </section>
  </main>


<script>
/* ===========================
   Config (solo in lettura)
=========================== */
const SUPABASE_URL = "https://oiudaxsyvhjpjjhglejd.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pdWRheHN5dmhqcGpqaGdsZWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDk0OTcsImV4cCI6MjA3OTU4NTQ5N30.r7kz3FdijAhsJLz1DcEtobJLaPCqygrQGgCPpSc-05A";

async function sbFetch(table, query) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY,
    },
  });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}

/* ===========================
    UTIL
=========================== */
function pad2(n){return n<10?"0"+n:""+n;}
function formatDateIT(str){
  const [y,m,d]=str.split("-").map(Number);
  const dt=new Date(y,m-1,d);
  return dt.toLocaleDateString("it-IT",{weekday:"short",day:"2-digit",month:"short"});
}
function getDateStrOffset(off){
  const dt=new Date();dt.setDate(dt.getDate()+off);
  return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
}
function safeOdd(o){const n=Number(o);return n>1?n:1;}

/* ===========================
   NOMI PREMIUM DELLE FAMIGLIE
=========================== */

const CATEGORY_LABELS = {
  BEST_TIPS_OF_DAY: "Scelte d’Élite",
  SAFE_PICKS: "Selezioni Affidabili",
  VALUE_PICKS: "Quote di Valore",
  OVER_UNDER_TIPS: "Tendenze Goal",
  BTTS_TIPS: "Probabilità Entrambe",
  DAILY_2PLUS: "Combo Selettiva",
  DAILY_10PLUS: "Combo High Stakes",
  SINGLE_GAME: "Pick Esclusiva"
};

function getCategoryLabel(cat){
  const k=(cat||"").trim().toUpperCase();
  return CATEGORY_LABELS[k] || (cat||"Altro").replace(/_/g," ");
}

/* ===========================
   LOGICA STORICO
=========================== */

async function loadHistory(days){
  const catBox=document.getElementById("category-summary");
  const tableBox=document.getElementById("table-container");
  tableBox.innerHTML=`<div class="table-wrapper"><div class="empty">Caricamento…</div></div>`;
  catBox.innerHTML="";

  const to=getDateStrOffset(0);
  const from=getDateStrOffset(-days+1);

  /* --- 1. Risultati grezzi --- */
  const rawRes = await sbFetch("results", `?picks_date=gte.${from}&picks_date=lte.${to}&select=*`);
  if (!rawRes.length){
    tableBox.innerHTML=`<div class="table-wrapper"><div class="empty">Nessun dato disponibile.</div></div>`;
    return;
  }

  /* --- 2. Deduplica per fixture+categoria+pick --- */
  const map = new Map();
  for (const r of rawRes){
    if (!r.fixture_id || !r.pick) continue;
    const key=`${r.fixture_id}__${(r.category||"").trim()}__${r.pick.trim()}`;
    map.set(key,r);
  }
  const results=[...map.values()];

  /* --- 3. Recuperiamo le quote --- */
  const rawPicks = await sbFetch("picks", `?run_date=gte.${from}&run_date=lte.${to}&select=*`);
  const pickMap=new Map();
  for(const p of rawPicks){
    const key=`${p.fixture_id}__${(p.category||"").trim()}__${p.pick.trim()}`;
    pickMap.set(key,p);
  }

  /* --- 4. Aggregazione --- */
  const byDay=new Map();
  const byCat=new Map();
  let TW=0, TL=0, TS=0, TP=0;

  for(const r of results){
    const d=r.picks_date||r.match_date;
    const res=(r.result||"").toUpperCase();
    if(res!=="WIN"&&res!=="LOSE") continue;

    const key=`${r.fixture_id}__${(r.category||"").trim()}__${r.pick.trim()}`;
    const p=pickMap.get(key);
    const odd=safeOdd(p?.odd);

    const win=res==="WIN";
    const profit = win ? (odd-1) : -1;

    /* DAY */
    if(!byDay.has(d)) byDay.set(d,{w:0,l:0,s:0,p:0});
    const D=byDay.get(d);
    D.s+=1; D.p+=profit; if(win)D.w++; else D.l++;

    /* CAT */
    const c=(r.category||"Altro").trim()||"Altro";
    if(!byCat.has(c)) byCat.set(c,{w:0,l:0,s:0,p:0});
    const C=byCat.get(c);
    C.s+=1; C.p+=profit; if(win)C.w++; else C.l++;

    /* TOTALI */
    TS+=1; TP+=profit; if(win)TW++; else TL++;
  }

  /* --- 5. Riepilogo generale --- */
  const daysList=[...byDay.keys()].sort();
  const first=daysList[0], last=daysList[daysList.length-1];
  document.getElementById("summary-period").textContent=`${formatDateIT(first)} → ${formatDateIT(last)}`;
  document.getElementById("summary-days").textContent=`${daysList.length} giorni`;

  const played=TW+TL;
  const wr = played? ((TW/played)*100).toFixed(1)+"%":"-";
  const roi = TS? ((TP/TS)*100).toFixed(1)+"%":"-";

  document.getElementById("summary-winrate").textContent=wr;
  document.getElementById("summary-wl").textContent=`${TW} win / ${TL} lose`;

  document.getElementById("summary-roi").textContent=roi;
  document.getElementById("summary-profit").textContent=`Profitto: ${TP.toFixed(2)} su stake ${TS}`;

  /* --- 6. ROI per categoria premium --- */
  let cHtml = `
    <div class="cat-title">ROI per famiglia</div>
    <div class="cat-sub">Valutazione con stake fisso per pick chiuso nel periodo selezionato.</div>
    <div class="cat-grid">
  `;

  const cats=[...byCat.entries()].map(([k,v])=>{
    const played=v.w+v.l;
    return {
      k,
      label:getCategoryLabel(k),
      played,
      wr: played?((v.w/played)*100).toFixed(1):"-",
      roi: v.s?((v.p/v.s)*100).toFixed(1):"-",
      p:v.p.toFixed(2)
    };
  });

  /* ordina per ROI */
  cats.sort((a,b)=> parseFloat(b.roi||"-Infinity") - parseFloat(a.roi||"-Infinity"));

  for(const c of cats){
    const roiClass = c.roi=="-"?"neu":(parseFloat(c.roi)>=0?"pos":"neg");
    const pClass = parseFloat(c.p)>0?"pos":(parseFloat(c.p)<0?"neg":"neu");

    cHtml+=`
      <div class="cat-card">
        <div class="cat-name">${c.label}</div>

        <div class="cm-row">
          <div class="cat-metric-label">ROI</div>
          <div class="cat-metric-value ${roiClass}">${c.roi=="-"? "-": c.roi+"%"}</div>
        </div>

        <div class="cm-row">
          <div class="cat-metric-label">Winrate</div>
          <div class="cat-metric-value">${c.wr=="-"? "-": c.wr+"%"}</div>
        </div>

        <div class="cm-row">
          <div class="cat-metric-label">Picks</div>
          <div class="cat-metric-value">${c.played}</div>
        </div>

        <div class="cm-row">
          <div class="cat-metric-label">Profitto</div>
          <div class="cat-metric-value ${pClass}">${c.p}</div>
        </div>
      </div>
    `;
  }

  cHtml+="</div>";
  catBox.innerHTML=cHtml;

  /* --- 7. Tabella per giorno --- */
  let tHtml = `
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Picks</th>
            <th>Win</th>
            <th>Lose</th>
            <th>Winrate</th>
            <th>ROI</th>
            <th>Profitto</th>
          </tr>
        </thead>
        <tbody>
  `;

  for(const d of daysList.reverse()){
    const D=byDay.get(d);
    const played=D.w+D.l;
    const wr=played?((D.w/played)*100).toFixed(1)+"%":"-";
    const roi=D.s?((D.p/D.s)*100).toFixed(1)+"%":"-";

    tHtml+=`
      <tr>
        <td>${formatDateIT(d)}</td>
        <td>${played}</td>
        <td>${D.w}</td>
        <td>${D.l}</td>
        <td>${wr}</td>
        <td>${roi}</td>
        <td>${D.p.toFixed(2)}</td>
      </tr>
    `;
  }

  tHtml+="</tbody></table></div>";
  tableBox.innerHTML=tHtml;
}

/* ===========================
   INIT
=========================== */
document.addEventListener("DOMContentLoaded",()=>{
  const select=document.getElementById("range-select");
  loadHistory(parseInt(select.value,10));
  select.addEventListener("change",()=>loadHistory(parseInt(select.value,10)));
});
</script>

</body>
</html>
